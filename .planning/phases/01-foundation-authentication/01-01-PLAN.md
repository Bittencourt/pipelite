---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - drizzle.config.ts
  - .env.example
  - src/db/index.ts
  - src/db/schema/users.ts
  - src/db/schema/sessions.ts
  - src/db/schema/accounts.ts
  - src/db/schema/verification-tokens.ts
  - src/db/schema/api-keys.ts
  - src/db/schema/domain-whitelist.ts
  - src/db/schema/rejected-signups.ts
  - src/db/schema/index.ts
autonomous: true
user_setup:
  - service: PostgreSQL
    why: "Primary database for users, sessions, and all CRM data"
    env_vars:
      - name: DATABASE_URL
        source: "PostgreSQL connection string (e.g., postgresql://user:pass@localhost:5432/pipelite)"
  - service: SMTP Server
    why: "Email sending for verification, approval notifications, password reset"
    env_vars:
      - name: SMTP_HOST
        source: "SMTP server hostname"
      - name: SMTP_PORT
        source: "SMTP port (typically 587 for TLS, 465 for SSL)"
      - name: SMTP_USER
        source: "SMTP authentication username"
      - name: SMTP_PASSWORD
        source: "SMTP authentication password"

must_haves:
  truths:
    - "Next.js project compiles without errors"
    - "Database schema defines all auth-related tables"
    - "Drizzle client can connect to database"
    - "All required dependencies are installed"
  artifacts:
    - path: "package.json"
      provides: "Project dependencies"
      contains: "next-auth, drizzle-orm, argon2, nodemailer, react-hook-form, @hookform/resolvers, @tanstack/react-table"
    - path: "src/db/schema/users.ts"
      provides: "User model with role and status"
      min_lines: 30
    - path: "src/db/schema/api-keys.ts"
      provides: "API key model with hash storage"
      min_lines: 20
    - path: "src/db/index.ts"
      provides: "Drizzle database client"
      exports: ["db"]
  key_links:
    - from: "src/db/schema/index.ts"
      to: "all schema files"
      via: " barrel export"
      pattern: "export \\* from"
---

<objective>
Initialize Next.js project with all required dependencies and create the complete database schema for authentication.

Purpose: Establish the foundational infrastructure that all subsequent plans depend on - database schema, ORM client, and project dependencies.

Output: Working Next.js project with Drizzle ORM configured and all auth tables defined (users, sessions, accounts, verificationTokens, apiKeys, domainWhitelist, rejectedSignups).
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Next.js project and install dependencies</name>
  <files>
    package.json
    tsconfig.json
    .env.example
    .env.local
  </files>
  <action>
    Initialize a fresh Next.js 16+ project with TypeScript, then install all required dependencies.

    **Steps:**
    1. Run `npx create-next-app@latest . --typescript --tailwind --eslint --app --src-dir --import-alias "@/*" --turbopack --yes`
    2. Install core dependencies:
       - `npm install next-auth@beta @auth/drizzle-adapter drizzle-orm drizzle-kit postgres argon2 nodemailer ioredis zod react-hook-form @hookform/resolvers @tanstack/react-table`
    3. Install dev dependencies:
       - `npm install -D @types/nodemailer`
    4. Initialize shadcn/ui:
       - `npx shadcn@latest init -y`
    5. Add shadcn components needed for auth:
       - `npx shadcn@latest add button input label card dialog table form badge dropdown-menu avatar`
    
    **Create .env.example with all required variables:**
    ```
    # Database
    DATABASE_URL="postgresql://user:password@localhost:5432/pipelite"
    
    # Auth.js
    AUTH_SECRET="generate-with-openssl-rand-base64-32"
    NEXTAUTH_URL="http://localhost:3000"
    
    # SMTP (email)
    SMTP_HOST="smtp.example.com"
    SMTP_PORT="587"
    SMTP_SECURE="false"
    SMTP_USER="your-smtp-user"
    SMTP_PASSWORD="your-smtp-password"
    EMAIL_FROM="noreply@example.com"
    
    # Redis (optional, for session caching)
    REDIS_URL="redis://localhost:6379"
    ```

    **Important:** Do NOT hardcode any secrets. Use process.env throughout.
  </action>
  <verify>
    - `npm run build` exits with code 0
    - `cat package.json | grep -E "next-auth|drizzle-orm|argon2|nodemailer"` shows all packages
    - `.env.example` file exists with all required variables
  </verify>
  <done>
    - Next.js project initialized with TypeScript and Tailwind
    - All auth dependencies installed (next-auth@beta, drizzle-orm, argon2, nodemailer, zod)
    - shadcn/ui initialized with button, input, label, card, dialog, table, form, badge, dropdown-menu, avatar components
    - .env.example contains DATABASE_URL, AUTH_SECRET, NEXTAUTH_URL, SMTP_*, EMAIL_FROM, REDIS_URL
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema files</name>
  <files>
    src/db/schema/users.ts
    src/db/schema/sessions.ts
    src/db/schema/accounts.ts
    src/db/schema/verification-tokens.ts
    src/db/schema/api-keys.ts
    src/db/schema/domain-whitelist.ts
    src/db/schema/rejected-signups.ts
    src/db/schema/index.ts
  </files>
  <action>
    Create Drizzle schema files following Auth.js adapter requirements plus custom fields.

    **src/db/schema/users.ts:**
    ```typescript
    import { pgTable, text, timestamp, pgEnum } from "drizzle-orm/pg-core"
    import { relations } from "drizzle-orm"

    export const userRoleEnum = pgEnum('user_role', ['admin', 'member'])
    export const userStatusEnum = pgEnum('user_status', [
      'pending_verification',
      'pending_approval',
      'approved',
      'rejected'
    ])

    export const users = pgTable('users', {
      id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
      email: text('email').notNull().unique(),
      emailVerified: timestamp('email_verified', { mode: 'date' }),
      name: text('name'),
      image: text('image'),
      passwordHash: text('password_hash'),
      role: userRoleEnum('role').default('member').notNull(),
      status: userStatusEnum('status').default('pending_verification').notNull(),
      createdAt: timestamp('created_at').defaultNow().notNull(),
      updatedAt: timestamp('updated_at').defaultNow().notNull(),
      deletedAt: timestamp('deleted_at'), // Soft delete pattern - CRITICAL
    })

    export const usersRelations = relations(users, ({ many }) => ({
      sessions: many(sessions),
      accounts: many(accounts),
      apiKeys: many(apiKeys),
    }))
    ```

    **src/db/schema/sessions.ts (Auth.js standard):**
    ```typescript
    import { pgTable, text, timestamp, integer } from "drizzle-orm/pg-core"
    import { relations } from "drizzle-orm"
    import { users } from "./users"

    export const sessions = pgTable('sessions', {
      sessionToken: text('session_token').primaryKey(),
      userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
      expires: timestamp('expires', { mode: 'date' }).notNull(),
    })

    export const sessionsRelations = relations(sessions, ({ one }) => ({
      user: one(users, {
        fields: [sessions.userId],
        references: [users.id],
      }),
    }))
    ```

    **src/db/schema/accounts.ts (Auth.js standard - for OAuth future-proofing):**
    ```typescript
    import { pgTable, text, timestamp, integer } from "drizzle-orm/pg-core"
    import { relations } from "drizzle-orm"
    import { users } from "./users"

    export const accounts = pgTable('accounts', {
      id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
      userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
      type: text('type').notNull(), // oauth, email, credentials
      provider: text('provider').notNull(),
      providerAccountId: text('provider_account_id').notNull(),
      refresh_token: text('refresh_token'),
      access_token: text('access_token'),
      expires_at: integer('expires_at'),
      token_type: text('token_type'),
      scope: text('scope'),
      id_token: text('id_token'),
      session_state: text('session_state'),
    })

    export const accountsRelations = relations(accounts, ({ one }) => ({
      user: one(users, {
        fields: [accounts.userId],
        references: [users.id],
      }),
    }))
    ```

    **src/db/schema/verification-tokens.ts:**
    ```typescript
    import { pgTable, text, timestamp } from "drizzle-orm/pg-core"

    export const verificationTokens = pgTable('verification_tokens', {
      identifier: text('identifier').notNull(),
      token: text('token').notNull().unique(),
      expires: timestamp('expires', { mode: 'date' }).notNull(),
    })
    ```

    **src/db/schema/api-keys.ts:**
    ```typescript
    import { pgTable, text, timestamp } from "drizzle-orm/pg-core"
    import { relations } from "drizzle-orm"
    import { users } from "./users"

    export const apiKeys = pgTable('api_keys', {
      id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
      userId: text('user_id').notNull().references(() => users.id, { onDelete: 'cascade' }),
      name: text('name').notNull(), // e.g., "Zapier", "Scripts"
      keyPrefix: text('key_prefix').notNull(), // First 12 chars for display
      keyHash: text('key_hash').notNull(), // SHA-256 hash - NEVER store full key
      createdAt: timestamp('created_at').defaultNow().notNull(),
      lastUsedAt: timestamp('last_used_at'),
      deletedAt: timestamp('deleted_at'), // Soft delete - regenerate only, no hard delete
    })

    export const apiKeysRelations = relations(apiKeys, ({ one }) => ({
      user: one(users, {
        fields: [apiKeys.userId],
        references: [users.id],
      }),
    }))
    ```

    **src/db/schema/domain-whitelist.ts:**
    ```typescript
    import { pgTable, text, timestamp } from "drizzle-orm/pg-core"

    export const domainWhitelist = pgTable('domain_whitelist', {
      id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
      domain: text('domain').notNull().unique(), // e.g., "company.com"
      createdAt: timestamp('created_at').defaultNow().notNull(),
    })
    ```

    **src/db/schema/rejected-signups.ts:**
    ```typescript
    import { pgTable, text, timestamp } from "drizzle-orm/pg-core"
    import { users } from "./users"

    export const rejectedSignups = pgTable('rejected_signups', {
      id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
      email: text('email').notNull(),
      rejectedBy: text('rejected_by').references(() => users.id),
      rejectedAt: timestamp('rejected_at').defaultNow().notNull(),
      reason: text('reason'),
    })
    ```

    **src/db/schema/index.ts (barrel export):**
    ```typescript
    export * from "./users"
    export * from "./sessions"
    export * from "./accounts"
    export * from "./verification-tokens"
    export * from "./api-keys"
    export * from "./domain-whitelist"
    export * from "./rejected-signups"
    ```

    **CRITICAL:** Every table MUST have deletedAt timestamp for soft-delete pattern. This is non-negotiable for Phase 1 as it sets the pattern for all future phases.
  </action>
  <verify>
    - All 7 schema files exist in src/db/schema/
    - `grep -l "deletedAt" src/db/schema/*.ts` returns users.ts and api-keys.ts (the ones that need it)
    - `grep "userStatusEnum" src/db/schema/users.ts` confirms status enum exists
    - `grep "keyHash" src/db/schema/api-keys.ts` confirms hash storage pattern
    - No TypeScript errors: `npx tsc --noEmit` passes
  </verify>
  <done>
    - 7 schema files created with proper Drizzle ORM definitions
    - users table has role (admin/member) and status (pending_verification → pending_approval → approved/rejected)
    - apiKeys table stores keyHash (SHA-256), keyPrefix (display), never full key
    - domainWhitelist table for email domain restrictions
    - rejectedSignups table for audit trail
    - All tables follow Auth.js adapter conventions
    - Soft delete pattern established (deletedAt on applicable tables)
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Drizzle client and configuration</name>
  <files>
    drizzle.config.ts
    src/db/index.ts
  </files>
  <action>
    Create Drizzle ORM client and migration configuration.

    **drizzle.config.ts:**
    ```typescript
    import type { Config } from "drizzle-kit"

    export default {
      schema: "./src/db/schema/index.ts",
      out: "./drizzle",
      dialect: "postgresql",
      dbCredentials: {
        url: process.env.DATABASE_URL!,
      },
    } satisfies Config
    ```

    **src/db/index.ts:**
    ```typescript
    import { drizzle } from "drizzle-orm/postgres-js"
    import postgres from "postgres"
    import * as schema from "./schema"

    // Validate DATABASE_URL at startup
    if (!process.env.DATABASE_URL) {
      throw new Error("DATABASE_URL environment variable is not set")
    }

    const connectionString = process.env.DATABASE_URL

    // For queries (connection pool)
    const queryClient = postgres(connectionString)

    // For migrations (single connection)
    const migrationClient = postgres(connectionString, { max: 1 })

    export const db = drizzle(queryClient, { schema })

    // For use with drizzle-kit migrations
    export const migrationDb = drizzle(migrationClient, { schema })
    ```

    **Add npm scripts to package.json:**
    ```json
    {
      "scripts": {
        "db:generate": "drizzle-kit generate",
        "db:migrate": "drizzle-kit migrate",
        "db:push": "drizzle-kit push",
        "db:studio": "drizzle-kit studio"
      }
    }
    ```

    **Do NOT run migrations yet** - that requires a running database which is user-provided. Just set up the configuration.
  </action>
  <verify>
    - `cat drizzle.config.ts` shows correct schema path and postgresql dialect
    - `cat src/db/index.ts` exports db and validates DATABASE_URL
    - `npm run db:generate -- --help` shows drizzle-kit help (confirms script works)
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - drizzle.config.ts configured for PostgreSQL
    - src/db/index.ts exports validated Drizzle client with all schema relations
    - npm scripts for db:generate, db:migrate, db:push, db:studio added
    - Project compiles without TypeScript errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds without errors
2. All schema files exist with proper Drizzle definitions
3. Drizzle client exports working db instance
4. All environment variables documented in .env.example
5. shadcn/ui components available in src/components/ui/
</verification>

<success_criteria>
- Next.js 16+ project initialized with TypeScript, Tailwind, App Router
- All auth dependencies installed (next-auth@beta, drizzle-orm, argon2, nodemailer, zod, ioredis, react-hook-form, @hookform/resolvers, @tanstack/react-table)
- 7 database schema files created following Auth.js adapter conventions
- Drizzle client configured and exporting db
- Soft delete pattern (deletedAt) established on applicable tables
- shadcn/ui initialized with required components
- .env.example documents all required environment variables
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
