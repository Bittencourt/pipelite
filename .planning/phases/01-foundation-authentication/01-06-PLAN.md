---
phase: 01-foundation-authentication
plan: 06
type: execute
wave: 4
depends_on: ["01-02", "01-04"]
files_modified:
  - src/app/settings/layout.tsx
  - src/app/settings/api-keys/page.tsx
  - src/app/api/api-keys/route.ts
  - src/app/api/api-keys/[id]/route.ts
  - src/components/api-key-dialog.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "User can view list of their API keys with masked display"
    - "User can create a new named API key"
    - "Full API key is shown exactly once on creation"
    - "User can regenerate an API key (new key value, same name)"
    - "Deleted keys are not visible (but retained in database)"
    - "Only the key owner can manage their keys"
  artifacts:
    - path: "src/app/settings/api-keys/page.tsx"
      provides: "API key management UI"
      contains: "apiKeys"
    - path: "src/app/api/api-keys/route.ts"
      provides: "API key CRUD endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/api/api-keys/[id]/route.ts"
      provides: "Single key operations"
      exports: ["POST"] # regenerate
    - path: "src/components/api-key-dialog.tsx"
      provides: "Key creation dialog with one-time display"
      contains: "fullKey"
  key_links:
    - from: "src/app/api/api-keys/route.ts"
      to: "src/lib/api-keys.ts"
      via: "generateApiKey"
      pattern: "generateApiKey"
    - from: "src/app/settings/api-keys/page.tsx"
      to: "src/app/api/api-keys/route.ts"
      via: "fetch"
      pattern: "fetch.*api-keys"
---

<objective>
Implement API key management allowing users to create, view (masked), and regenerate API keys for external access.

Purpose: Enable users to generate API keys for external tool integration (Zapier, scripts, etc.). Keys are stored as hashes, shown in full exactly once on creation, and can be regenerated (creating a new key value while keeping the name).

Output: API key settings page, CRUD endpoints, key creation dialog with one-time full key display, and regenerate functionality.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create API key CRUD endpoints</name>
  <files>
    src/app/api/api-keys/route.ts
    src/app/api/api-keys/[id]/route.ts
  </files>
  <action>
    Create API routes for listing, creating, and regenerating API keys.

    **src/app/api/api-keys/route.ts:**
    ```typescript
    import { NextRequest, NextResponse } from "next/server"
    import { auth } from "@/auth"
    import { db } from "@/db"
    import { apiKeys } from "@/db/schema/api-keys"
    import { eq, and, isNull, desc } from "drizzle-orm"
    import { generateApiKey, maskFromPrefix } from "@/lib/api-keys"
    import { z } from "zod"

    const createKeySchema = z.object({
      name: z.string().min(1).max(100),
    })

    // GET /api/api-keys - List user's API keys
    export async function GET() {
      const session = await auth()

      if (!session?.user) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
      }

      const keys = await db
        .select({
          id: apiKeys.id,
          name: apiKeys.name,
          keyPrefix: apiKeys.keyPrefix,
          createdAt: apiKeys.createdAt,
          lastUsedAt: apiKeys.lastUsedAt,
        })
        .from(apiKeys)
        .where(
          and(
            eq(apiKeys.userId, session.user.id),
            isNull(apiKeys.deletedAt)
          )
        )
        .orderBy(desc(apiKeys.createdAt))

      // Mask the key prefix for display
      const maskedKeys = keys.map((key) => ({
        ...key,
        maskedKey: maskFromPrefix(key.keyPrefix),
      }))

      return NextResponse.json({ keys: maskedKeys })
    }

    // POST /api/api-keys - Create new API key
    export async function POST(request: NextRequest) {
      const session = await auth()

      if (!session?.user) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
      }

      try {
        const body = await request.json()
        const result = createKeySchema.safeParse(body)

        if (!result.success) {
          return NextResponse.json(
            { error: result.error.errors[0]?.message || "Invalid input" },
            { status: 400 }
          )
        }

        const { name } = result.data

        // Check for duplicate name
        const existing = await db.query.apiKeys.findFirst({
          where: and(
            eq(apiKeys.userId, session.user.id),
            eq(apiKeys.name, name),
            isNull(apiKeys.deletedAt)
          ),
        })

        if (existing) {
          return NextResponse.json(
            { error: "An API key with this name already exists" },
            { status: 400 }
          )
        }

        // Generate the key
        const { fullKey, keyPrefix, id } = await generateApiKey(
          session.user.id,
          name
        )

        // Return full key ONCE - this is the only time it will be visible
        return NextResponse.json({
          id,
          name,
          fullKey, // Only shown once!
          keyPrefix,
          maskedKey: maskFromPrefix(keyPrefix),
          createdAt: new Date(),
        })
      } catch (error) {
        console.error("Create API key error:", error)
        return NextResponse.json(
          { error: "Failed to create API key" },
          { status: 500 }
        )
      }
    }
    ```

    **src/app/api/api-keys/[id]/route.ts:**
    ```typescript
    import { NextRequest, NextResponse } from "next/server"
    import { auth } from "@/auth"
    import { db } from "@/db"
    import { apiKeys } from "@/db/schema/api-keys"
    import { eq, and, isNull } from "drizzle-orm"
    import { regenerateApiKey, maskFromPrefix } from "@/lib/api-keys"

    // POST /api/api-keys/[id] - Regenerate API key
    export async function POST(
      request: NextRequest,
      { params }: { params: Promise<{ id: string }> }
    ) {
      const session = await auth()

      if (!session?.user) {
        return NextResponse.json({ error: "Unauthorized" }, { status: 401 })
      }

      try {
        const { id } = await params

        // Verify the key belongs to this user
        const existingKey = await db.query.apiKeys.findFirst({
          where: and(
            eq(apiKeys.id, id),
            eq(apiKeys.userId, session.user.id),
            isNull(apiKeys.deletedAt)
          ),
        })

        if (!existingKey) {
          return NextResponse.json(
            { error: "API key not found" },
            { status: 404 }
          )
        }

        // Regenerate the key (soft-deletes old, creates new)
        const result = await regenerateApiKey(id, session.user.id)

        if (!result) {
          return NextResponse.json(
            { error: "Failed to regenerate API key" },
            { status: 500 }
          )
        }

        // Return full key ONCE
        return NextResponse.json({
          id: result.id,
          name: existingKey.name,
          fullKey: result.fullKey, // Only shown once!
          keyPrefix: result.keyPrefix,
          maskedKey: maskFromPrefix(result.keyPrefix),
          createdAt: new Date(),
        })
      } catch (error) {
        console.error("Regenerate API key error:", error)
        return NextResponse.json(
          { error: "Failed to regenerate API key" },
          { status: 500 }
        )
      }
    }

    // DELETE is not implemented - users can only regenerate, not delete
    // This is by design as per requirements
    ```

    **Note:** No DELETE endpoint by design - users regenerate keys instead of deleting them. This maintains a record of all keys ever created.
  </action>
  <verify>
    - `cat src/app/api/api-keys/route.ts | grep "generateApiKey"` confirms key generation
    - `cat src/app/api/api-keys/route.ts | grep "fullKey"` confirms one-time return
    - `cat src/app/api/api-keys/\[id\]/route.ts | grep "regenerateApiKey"` confirms regeneration
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - GET /api/api-keys returns user's non-deleted keys (masked)
    - POST /api/api-keys creates new key, returns full key once
    - POST /api/api-keys/[id] regenerates key, returns full key once
    - No DELETE endpoint (regenerate only per requirements)
    - Duplicate name check on creation
    - Authorization: users can only manage their own keys
  </done>
</task>

<task type="auto">
  <name>Task 2: Create API key settings page</name>
  <files>
    src/app/settings/layout.tsx
    src/app/settings/api-keys/page.tsx
    src/components/api-key-dialog.tsx
  </files>
  <action>
    Create API key management page with list, create dialog, and regenerate functionality.

    **src/app/settings/layout.tsx:**
    ```typescript
    import { auth } from "@/auth"
    { redirect } from "next/navigation"
    { Settings, Key } from "lucide-react"
    { cn } from "@/lib/utils"
    { Button } from "@/components/ui/button"

    const settingsNav = [
      {
        title: "API Keys",
        href: "/settings/api-keys",
        icon: Key,
      },
    ]

    export default async function SettingsLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const session = await auth()

      if (!session) {
        redirect("/login?callbackUrl=/settings")
      }

      return (
        <div className="container py-8">
          <div className="flex flex-col md:flex-row gap-8">
            <aside className="w-full md:w-64 shrink-0">
              <div className="space-y-1">
                {settingsNav.map((item) => (
                  <a
                    key={item.href}
                    href={item.href}
                    className={cn(
                      "flex items-center gap-3 px-3 py-2 rounded-md text-sm font-medium",
                      "bg-muted text-foreground"
                    )}
                  >
                    <item.icon className="h-4 w-4" />
                    {item.title}
                  </a>
                ))}
              </div>
            </aside>
            <main className="flex-1">{children}</main>
          </div>
        </div>
      )
    }
    ```

    **src/components/api-key-dialog.tsx:**
    ```typescript
    "use client"

    import { useState } from "react"
    { useForm } from "react-hook-form"
    { zodResolver } from "@hookform/resolvers/zod"
    { z } from "zod"
    {
      Dialog,
      DialogContent,
      DialogDescription,
      DialogHeader,
      DialogTitle,
    } from "@/components/ui/dialog"
    { Button } from "@/components/ui/button"
    { Input } from "@/components/ui/input"
    { Label } from "@/components/ui/label"
    { Loader2, Copy, Check } from "lucide-react"
    { toast } from "sonner"

    const createKeySchema = z.object({
      name: z.string().min(1, "Name is required").max(100, "Name too long"),
    })

    type CreateKeyFormData = z.infer<typeof createKeySchema>

    interface ApiKeyDialogProps {
      open: boolean
      onOpenChange: (open: boolean) => void
      onSuccess: () => void
    }

    export function ApiKeyDialog({ open, onOpenChange, onSuccess }: ApiKeyDialogProps) {
      const [isLoading, setIsLoading] = useState(false)
      const [createdKey, setCreatedKey] = useState<string | null>(null)
      const [copied, setCopied] = useState(false)

      const {
        register,
        handleSubmit,
        reset,
        formState: { errors },
      } = useForm<CreateKeyFormData>({
        resolver: zodResolver(createKeySchema),
      })

      const onSubmit = async (data: CreateKeyFormData) => {
        setIsLoading(true)
        try {
          const response = await fetch("/api/api-keys", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(data),
          })

          const result = await response.json()

          if (!response.ok) {
            toast.error(result.error || "Failed to create API key")
            return
          }

          // Show the full key ONCE
          setCreatedKey(result.fullKey)
          toast.success("API key created!")
          onSuccess()
        } catch (error) {
          toast.error("An unexpected error occurred")
        } finally {
          setIsLoading(false)
        }
      }

      const handleCopy = async () => {
        if (createdKey) {
          await navigator.clipboard.writeText(createdKey)
          setCopied(true)
          toast.success("Copied to clipboard")
          setTimeout(() => setCopied(false), 2000)
        }
      }

      const handleClose = () => {
        reset()
        setCreatedKey(null)
        setCopied(false)
        onOpenChange(false)
      }

      return (
        <Dialog open={open} onOpenChange={handleClose}>
          <DialogContent className="sm:max-w-md">
            {createdKey ? (
              <>
                <DialogHeader>
                  <DialogTitle>API Key Created!</DialogTitle>
                  <DialogDescription>
                    Copy this key now. You won&apos;t be able to see it again.
                  </DialogDescription>
                </DialogHeader>
                <div className="space-y-4">
                  <div className="flex items-center gap-2">
                    <code className="flex-1 p-3 bg-muted rounded-md text-sm break-all font-mono">
                      {createdKey}
                    </code>
                    <Button
                      size="icon"
                      variant="outline"
                      onClick={handleCopy}
                      className="shrink-0"
                    >
                      {copied ? (
                        <Check className="h-4 w-4 text-green-500" />
                      ) : (
                        <Copy className="h-4 w-4" />
                      )}
                    </Button>
                  </div>
                  <p className="text-sm text-muted-foreground">
                    Store this key securely. It provides full access to your account via the API.
                  </p>
                  <Button onClick={handleClose} className="w-full">
                    Done
                  </Button>
                </div>
              </>
            ) : (
              <>
                <DialogHeader>
                  <DialogTitle>Create API Key</DialogTitle>
                  <DialogDescription>
                    Give your API key a name to help you identify it later.
                  </DialogDescription>
                </DialogHeader>
                <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
                  <div className="space-y-2">
                    <Label htmlFor="name">Name</Label>
                    <Input
                      id="name"
                      placeholder="e.g., Zapier, Scripts, Testing"
                      {...register("name")}
                      disabled={isLoading}
                    />
                    {errors.name && (
                      <p className="text-sm text-red-500">{errors.name.message}</p>
                    )}
                  </div>
                  <div className="flex justify-end gap-2">
                    <Button
                      type="button"
                      variant="outline"
                      onClick={handleClose}
                      disabled={isLoading}
                    >
                      Cancel
                    </Button>
                    <Button type="submit" disabled={isLoading}>
                      {isLoading && <Loader2 className="mr-2 h-4 w-4 animate-spin" />}
                      Create Key
                    </Button>
                  </div>
                </form>
              </>
            )}
          </DialogContent>
        </Dialog>
      )
    }
    ```

    **src/app/settings/api-keys/page.tsx:**
    ```typescript
    "use client"

    import { useState, useEffect } from "react"
    { Button } from "@/components/ui/button"
    { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
    {
      Table,
      TableBody,
      TableCell,
      TableHead,
      TableHeader,
      TableRow,
    } from "@/components/ui/table"
    {
      Dialog,
      DialogContent,
      DialogDescription,
      DialogFooter,
      DialogHeader,
      DialogTitle,
    } from "@/components/ui/dialog"
    { Loader2, Plus, RefreshCw, Copy, Check, Key } from "lucide-react"
    { toast } from "sonner"
    { ApiKeyDialog } from "@/components/api-key-dialog"

    interface ApiKey {
      id: string
      name: string
      maskedKey: string
      createdAt: string
      lastUsedAt: string | null
    }

    export default function ApiKeysPage() {
      const [keys, setKeys] = useState<ApiKey[]>([])
      const [isLoading, setIsLoading] = useState(true)
      const [dialogOpen, setDialogOpen] = useState(false)
      const [regenerateDialog, setRegenerateDialog] = useState<{
        open: boolean
        keyId: string | null
        keyName: string
        newKey: string | null
      }>({ open: false, keyId: null, keyName: "", newKey: null })
      const [copied, setCopied] = useState(false)

      const fetchKeys = async () => {
        try {
          const response = await fetch("/api/api-keys")
          const data = await response.json()
          setKeys(data.keys || [])
        } catch (error) {
          toast.error("Failed to load API keys")
        } finally {
          setIsLoading(false)
        }
      }

      useEffect(() => {
        fetchKeys()
      }, [])

      const handleRegenerate = async (keyId: string, keyName: string) => {
        setRegenerateDialog({ open: true, keyId, keyName, newKey: null })
      }

      const confirmRegenerate = async () => {
        if (!regenerateDialog.keyId) return

        try {
          const response = await fetch(`/api/api-keys/${regenerateDialog.keyId}`, {
            method: "POST",
          })

          const result = await response.json()

          if (!response.ok) {
            toast.error(result.error || "Failed to regenerate key")
            return
          }

          setRegenerateDialog({
            ...regenerateDialog,
            newKey: result.fullKey,
          })
          fetchKeys()
        } catch (error) {
          toast.error("Failed to regenerate key")
        }
      }

      const handleCopy = async () => {
        if (regenerateDialog.newKey) {
          await navigator.clipboard.writeText(regenerateDialog.newKey)
          setCopied(true)
          toast.success("Copied to clipboard")
          setTimeout(() => setCopied(false), 2000)
        }
      }

      const closeRegenerateDialog = () => {
        setRegenerateDialog({ open: false, keyId: null, keyName: "", newKey: null })
        setCopied(false)
      }

      return (
        <div className="space-y-6">
          <div className="flex items-center justify-between">
            <div>
              <h1 className="text-3xl font-bold">API Keys</h1>
              <p className="text-muted-foreground">
                Manage API keys for external tool access
              </p>
            </div>
            <Button onClick={() => setDialogOpen(true)}>
              <Plus className="mr-2 h-4 w-4" />
              Create Key
            </Button>
          </div>

          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Key className="h-5 w-5" />
                Your API Keys
              </CardTitle>
              <CardDescription>
                API keys allow external tools to access your account. 
                Keys are shown in full only once when created or regenerated.
              </CardDescription>
            </CardHeader>
            <CardContent>
              {isLoading ? (
                <div className="flex justify-center py-8">
                  <Loader2 className="h-8 w-8 animate-spin text-muted-foreground" />
                </div>
              ) : keys.length === 0 ? (
                <div className="text-center py-8 text-muted-foreground">
                  <p>No API keys yet.</p>
                  <p className="text-sm">Create one to get started.</p>
                </div>
              ) : (
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead>Name</TableHead>
                      <TableHead>Key</TableHead>
                      <TableHead>Created</TableHead>
                      <TableHead>Last Used</TableHead>
                      <TableHead className="text-right">Actions</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {keys.map((key) => (
                      <TableRow key={key.id}>
                        <TableCell className="font-medium">{key.name}</TableCell>
                        <TableCell>
                          <code className="text-sm bg-muted px-2 py-1 rounded">
                            {key.maskedKey}
                          </code>
                        </TableCell>
                        <TableCell>
                          {new Date(key.createdAt).toLocaleDateString()}
                        </TableCell>
                        <TableCell>
                          {key.lastUsedAt
                            ? new Date(key.lastUsedAt).toLocaleDateString()
                            : "Never"}
                        </TableCell>
                        <TableCell className="text-right">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => handleRegenerate(key.id, key.name)}
                          >
                            <RefreshCw className="mr-2 h-3 w-3" />
                            Regenerate
                          </Button>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              )}
            </CardContent>
          </Card>

          <ApiKeyDialog
            open={dialogOpen}
            onOpenChange={setDialogOpen}
            onSuccess={fetchKeys}
          />

          {/* Regenerate Dialog */}
          <Dialog open={regenerateDialog.open} onOpenChange={closeRegenerateDialog}>
            <DialogContent className="sm:max-w-md">
              {regenerateDialog.newKey ? (
                <>
                  <DialogHeader>
                    <DialogTitle>Key Regenerated!</DialogTitle>
                    <DialogDescription>
                      Copy this new key now. The old key is no longer valid.
                    </DialogDescription>
                  </DialogHeader>
                  <div className="space-y-4">
                    <div className="flex items-center gap-2">
                      <code className="flex-1 p-3 bg-muted rounded-md text-sm break-all font-mono">
                        {regenerateDialog.newKey}
                      </code>
                      <Button
                        size="icon"
                        variant="outline"
                        onClick={handleCopy}
                        className="shrink-0"
                      >
                        {copied ? (
                          <Check className="h-4 w-4 text-green-500" />
                        ) : (
                          <Copy className="h-4 w-4" />
                        )}
                      </Button>
                    </div>
                    <Button onClick={closeRegenerateDialog} className="w-full">
                      Done
                    </Button>
                  </div>
                </>
              ) : (
                <>
                  <DialogHeader>
                    <DialogTitle>Regenerate API Key</DialogTitle>
                    <DialogDescription>
                      Are you sure you want to regenerate &quot;{regenerateDialog.keyName}&quot;? 
                      The current key will stop working immediately.
                    </DialogDescription>
                  </DialogHeader>
                  <DialogFooter>
                    <Button variant="outline" onClick={closeRegenerateDialog}>
                      Cancel
                    </Button>
                    <Button onClick={confirmRegenerate}>
                      Regenerate
                    </Button>
                  </DialogFooter>
                </>
              )}
            </DialogContent>
          </Dialog>
        </div>
      )
    }
    ```
  </action>
  <verify>
    - `cat src/app/settings/api-keys/page.tsx | grep "regenerate"` confirms regenerate feature
    - `cat src/components/api-key-dialog.tsx | grep "fullKey"` confirms one-time display
    - `cat src/app/settings/api-keys/page.tsx | grep "maskedKey"` confirms masked display
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - /settings/api-keys page shows list of user's API keys
    - Keys displayed with masked format (pk_live_abc1****)
    - Create dialog with name input, shows full key once
    - Copy-to-clipboard for full key
    - Regenerate button for each key
    - Regenerate confirmation, then shows new full key
    - Empty state when no keys exist
    - Last used timestamp displayed
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete API key management:
    - Settings layout with navigation
    - API keys page with list view
    - Create dialog showing full key once
    - Regenerate functionality with new key display
    - Masked key display in list
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:3000
    2. Log in as any approved user
    3. Navigate to /settings/api-keys (via user menu or direct URL)
    4. Click "Create Key" button
    5. Enter a name (e.g., "Test Key") and submit
    6. Verify you see the full key (pk_live_...) with copy button
    7. Copy the key and save it somewhere
    8. Close dialog and verify key appears in list with masked format
    9. Click "Regenerate" on the key
    10. Confirm regeneration
    11. Verify you see a NEW full key (different from before)
    12. Verify the old key you saved no longer works (if you have a way to test API calls)
    13. Create another key with the same name - should show error
  </how-to-verify>
  <resume-signal>Type "approved" if API key workflow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. GET /api/api-keys returns user's keys (masked)
2. POST /api/api-keys creates key, returns full key once
3. POST /api/api-keys/[id] regenerates, returns new full key
4. Settings page shows key list with masked display
5. Create dialog shows full key exactly once
6. Regenerate shows confirmation then new key
7. Duplicate names rejected
</verification>

<success_criteria>
- /settings/api-keys shows user's API keys (masked: pk_live_abc1****)
- Create key dialog accepts name, shows full key once with copy button
- Regenerate button for each key shows confirmation
- Regenerated key shows new full key once, old key invalidated
- No delete option (regenerate only per requirements)
- Duplicate key names rejected
- Last used timestamp tracked and displayed
- Only key owner can view/manage their keys
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-06-SUMMARY.md`
</output>
