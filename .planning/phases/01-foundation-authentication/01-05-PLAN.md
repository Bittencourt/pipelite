---
phase: 01-foundation-authentication
plan: 05
type: execute
wave: 4
depends_on: ["01-03", "01-04"]
files_modified:
  - src/app/admin/layout.tsx
  - src/app/admin/users/page.tsx
  - src/app/admin/users/actions.ts
  - src/app/admin/users/columns.tsx
  - src/app/admin/users/data-table.tsx
  - src/app/admin/page.tsx
  - src/components/admin-sidebar.tsx
autonomous: false
user_setup: []

must_haves:
  truths:
    - "Admin can view list of users with pending_approval status"
    - "Only users with verified email appear in pending list"
    - "Admin can approve a pending user"
    - "Approved user receives email notification"
    - "Admin can reject a pending user"
    - "Rejected signups are logged with timestamp and admin ID"
    - "Non-admin users cannot access admin pages"
  artifacts:
    - path: "src/app/admin/users/page.tsx"
      provides: "Pending users list UI"
      contains: "pending_approval"
    - path: "src/app/admin/users/actions.ts"
      provides: "Approve/reject server actions"
      exports: ["approveUser", "rejectUser"]
    - path: "src/app/admin/layout.tsx"
      provides: "Admin-only layout with sidebar"
      contains: "role.*admin"
  key_links:
    - from: "src/app/admin/users/actions.ts"
      to: "src/lib/email/send.ts"
      via: "sendApprovalEmail"
      pattern: "sendApprovalEmail"
    - from: "src/app/admin/users/actions.ts"
      to: "src/db/schema/rejected-signups.ts"
      via: "db.insert(rejectedSignups)"
      pattern: "rejectedSignups"
---

<objective>
Implement the admin approval workflow with pending users list, approve/reject actions, and email notifications.

Purpose: Allow administrators to review and approve or reject user signups. Only users who have verified their email appear in the pending list. Rejections are logged for audit purposes.

Output: Admin layout with role protection, pending users table with approve/reject actions, approval emails sent to approved users, rejection logging.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-02-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin layout with role protection</name>
  <files>
    src/app/admin/layout.tsx
    src/app/admin/page.tsx
    src/components/admin-sidebar.tsx
  </files>
  <action>
    Create admin-only layout with sidebar navigation and role-based access control.

    **src/app/admin/layout.tsx:**
    ```typescript
    import { auth } from "@/auth"
    { redirect } from "next/navigation"
    { AdminSidebar } from "@/components/admin-sidebar"

    export default async function AdminLayout({
      children,
    }: {
      children: React.ReactNode
    }) {
      const session = await auth()

      if (!session) {
        redirect("/login?callbackUrl=/admin")
      }

      if (session.user.role !== "admin") {
        redirect("/?error=unauthorized")
      }

      return (
        <div className="flex min-h-[calc(100vh-3.5rem)]">
          <AdminSidebar />
          <main className="flex-1 p-6 bg-muted/30">
            {children}
          </main>
        </div>
      )
    }
    ```

    **src/components/admin-sidebar.tsx:**
    ```typescript
    "use client"

    import Link from "next/link"
    { usePathname } from "next/navigation"
    { Users, Settings, Home } from "lucide-react"
    { cn } from "@/lib/utils"
    { Button } from "@/components/ui/button"

    const sidebarItems = [
      {
        title: "Dashboard",
        href: "/admin",
        icon: Home,
      },
      {
        title: "User Management",
        href: "/admin/users",
        icon: Users,
      },
    ]

    export function AdminSidebar() {
      const pathname = usePathname()

      return (
        <aside className="w-64 border-r bg-background">
          <div className="flex flex-col h-full">
            <div className="p-4 border-b">
              <h2 className="text-lg font-semibold">Admin Panel</h2>
            </div>
            <nav className="flex-1 p-4 space-y-2">
              {sidebarItems.map((item) => {
                const isActive = pathname === item.href
                return (
                  <Link key={item.href} href={item.href}>
                    <Button
                      variant={isActive ? "secondary" : "ghost"}
                      className={cn(
                        "w-full justify-start",
                        isActive && "bg-secondary"
                      )}
                    >
                      <item.icon className="mr-2 h-4 w-4" />
                      {item.title}
                    </Button>
                  </Link>
                )
              })}
            </nav>
            <div className="p-4 border-t">
              <Link href="/">
                <Button variant="outline" className="w-full">
                  <Home className="mr-2 h-4 w-4" />
                  Back to App
                </Button>
              </Link>
            </div>
          </div>
        </aside>
      )
    }
    ```

    **src/app/admin/page.tsx:**
    ```typescript
    import { auth } from "@/auth"
    { db } from "@/db"
    import { users } from "@/db/schema/users"
    import { eq, count, and, isNull } from "drizzle-orm"
    { Card, CardContent, CardHeader, CardTitle } from "@/components/ui/card"
    { Users, UserCheck, UserX } from "lucide-react"

    export default async function AdminDashboard() {
      const session = await auth()

      // Get counts for dashboard
      const [pendingCount] = await db
        .select({ count: count() })
        .from(users)
        .where(
          and(
            eq(users.status, "pending_approval"),
            isNull(users.deletedAt)
          )
        )

      const [approvedCount] = await db
        .select({ count: count() })
        .from(users)
        .where(
          and(
            eq(users.status, "approved"),
            isNull(users.deletedAt)
          )
        )

      const [memberCount] = await db
        .select({ count: count() })
        .from(users)
        .where(
          and(
            eq(users.role, "member"),
            eq(users.status, "approved"),
            isNull(users.deletedAt)
          )
        )

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold">Admin Dashboard</h1>
            <p className="text-muted-foreground">
              Welcome back, {session?.user?.email?.split("@")[0]}
            </p>
          </div>

          <div className="grid gap-4 md:grid-cols-3">
            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Pending Approvals
                </CardTitle>
                <UserCheck className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{pendingCount.count}</div>
                <p className="text-xs text-muted-foreground">
                  Users awaiting approval
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Total Users
                </CardTitle>
                <Users className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{approvedCount.count}</div>
                <p className="text-xs text-muted-foreground">
                  Approved accounts
                </p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                <CardTitle className="text-sm font-medium">
                  Team Members
                </CardTitle>
                <Users className="h-4 w-4 text-muted-foreground" />
              </CardHeader>
              <CardContent>
                <div className="text-2xl font-bold">{memberCount.count}</div>
                <p className="text-xs text-muted-foreground">
                  Non-admin members
                </p>
              </CardContent>
            </Card>
          </div>

          {pendingCount.count > 0 && (
            <Card>
              <CardHeader>
                <CardTitle>Action Required</CardTitle>
              </CardHeader>
              <CardContent>
                <p className="text-muted-foreground">
                  You have {pendingCount.count} user{pendingCount.count !== 1 ? "s" : ""} waiting for approval.
                </p>
                <a
                  href="/admin/users"
                  className="text-primary hover:underline mt-2 inline-block"
                >
                  Review pending users →
                </a>
              </CardContent>
            </Card>
          )}
        </div>
      )
    }
    ```
  </action>
  <verify>
    - `cat src/app/admin/layout.tsx | grep "role.*admin"` confirms role check
    - `cat src/components/admin-sidebar.tsx | grep "User Management"` confirms sidebar link
    - `cat src/app/admin/page.tsx | grep "pending_approval"` confirms pending count query
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - /admin layout requires admin role (redirects non-admins)
    - Sidebar with Dashboard and User Management links
    - Admin dashboard shows pending approvals count
    - Dashboard links to pending users when count > 0
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pending users list page</name>
  <files>
    src/app/admin/users/page.tsx
    src/app/admin/users/columns.tsx
    src/app/admin/users/data-table.tsx
  </files>
  <action>
    Create pending users data table with @tanstack/react-table and shadcn/ui.

    **src/app/admin/users/columns.tsx:**
    ```typescript
    "use client"

    import { ColumnDef } from "@tanstack/react-table"
    { Badge } from "@/components/ui/badge"
    { Button } from "@/components/ui/button"
    { approveUser, rejectUser } from "./actions"
    { toast } from "sonner"
    { startTransition } from "react"

    export type PendingUser = {
      id: string
      email: string
      createdAt: Date
      emailVerified: Date | null
    }

    export const columns: ColumnDef<PendingUser>[] = [
      {
        accessorKey: "email",
        header: "Email",
        cell: ({ row }) => {
          return <span className="font-medium">{row.getValue("email")}</span>
        },
      },
      {
        accessorKey: "emailVerified",
        header: "Verified",
        cell: ({ row }) => {
          const verified = row.getValue("emailVerified") as Date | null
          if (!verified) {
            return <Badge variant="secondary">Not verified</Badge>
          }
          return (
            <Badge variant="default" className="bg-green-500">
              Verified
            </Badge>
          )
        },
      },
      {
        accessorKey: "createdAt",
        header: "Requested",
        cell: ({ row }) => {
          const date = new Date(row.getValue("createdAt"))
          return date.toLocaleDateString("en-US", {
            month: "short",
            day: "numeric",
            year: "numeric",
          })
        },
      },
      {
        id: "actions",
        header: "Actions",
        cell: ({ row, table }) => {
          const user = row.original
          const meta = table.options.meta as { refresh: () => void } | undefined

          const handleApprove = () => {
            startTransition(async () => {
              try {
                await approveUser(user.id)
                toast.success("User approved successfully")
                meta?.refresh()
              } catch (error) {
                toast.error("Failed to approve user")
              }
            })
          }

          const handleReject = () => {
            startTransition(async () => {
              try {
                await rejectUser(user.id)
                toast.success("User rejected")
                meta?.refresh()
              } catch (error) {
                toast.error("Failed to reject user")
              }
            })
          }

          return (
            <div className="flex gap-2">
              <Button
                size="sm"
                variant="default"
                onClick={handleApprove}
              >
                Approve
              </Button>
              <Button
                size="sm"
                variant="destructive"
                onClick={handleReject}
              >
                Reject
              </Button>
            </div>
          )
        },
      },
    ]
    ```

    **src/app/admin/users/data-table.tsx:**
    ```typescript
    "use client"

    import {
      ColumnDef,
      flexRender,
      getCoreRowModel,
      useReactTable,
    } from "@tanstack/react-table"
    import {
      Table,
      TableBody,
      TableCell,
      TableHead,
      TableHeader,
      TableRow,
    } from "@/components/ui/table"
    import { PendingUser } from "./columns"

    interface DataTableProps {
      columns: ColumnDef<PendingUser, unknown>[]
      data: PendingUser[]
      refresh?: () => void
    }

    export function DataTable({ columns, data, refresh }: DataTableProps) {
      const table = useReactTable({
        data,
        columns,
        getCoreRowModel: getCoreRowModel(),
        meta: {
          refresh: refresh || (() => {}),
        },
      })

      return (
        <div className="rounded-md border">
          <Table>
            <TableHeader>
              {table.getHeaderGroups().map((headerGroup) => (
                <TableRow key={headerGroup.id}>
                  {headerGroup.headers.map((header) => {
                    return (
                      <TableHead key={header.id}>
                        {header.isPlaceholder
                          ? null
                          : flexRender(
                              header.column.columnDef.header,
                              header.getContext()
                            )}
                      </TableHead>
                    )
                  })}
                </TableRow>
              ))}
            </TableHeader>
            <TableBody>
              {table.getRowModel().rows?.length ? (
                table.getRowModel().rows.map((row) => (
                  <TableRow
                    key={row.id}
                    data-state={row.getIsSelected() && "selected"}
                  >
                    {row.getVisibleCells().map((cell) => (
                      <TableCell key={cell.id}>
                        {flexRender(
                          cell.column.columnDef.cell,
                          cell.getContext()
                        )}
                      </TableCell>
                    ))}
                  </TableRow>
                ))
              ) : (
                <TableRow>
                  <TableCell
                    colSpan={columns.length}
                    className="h-24 text-center"
                  >
                    No pending users.
                  </TableCell>
                </TableRow>
              )}
            </TableBody>
          </Table>
        </div>
      )
    }
    ```

    **src/app/admin/users/page.tsx:**
    ```typescript
    import { db } from "@/db"
    import { users } from "@/db/schema/users"
    import { eq, isNull, desc } from "drizzle-orm"
    import { columns, PendingUser } from "./columns"
    import { DataTable } from "./data-table"
    import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card"
    import { UserCheck } from "lucide-react"

    async function getPendingUsers(): Promise<PendingUser[]> {
      const pendingUsers = await db
        .select({
          id: users.id,
          email: users.email,
          createdAt: users.createdAt,
          emailVerified: users.emailVerified,
        })
        .from(users)
        .where(
          eq(users.status, "pending_approval"),
          isNull(users.deletedAt)
        )
        .orderBy(desc(users.createdAt))

      return pendingUsers.map((user) => ({
        ...user,
        createdAt: user.createdAt,
        emailVerified: user.emailVerified,
      }))
    }

    export default async function AdminUsersPage() {
      const pendingUsers = await getPendingUsers()

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-3xl font-bold">User Management</h1>
            <p className="text-muted-foreground">
              Review and approve pending user signups
            </p>
          </div>

          <Card>
            <CardHeader>
              <div className="flex items-center gap-2">
                <UserCheck className="h-5 w-5 text-muted-foreground" />
                <CardTitle>Pending Approvals</CardTitle>
              </div>
              <CardDescription>
                Users who have verified their email and are waiting for approval
              </CardDescription>
            </CardHeader>
            <CardContent>
              <DataTable columns={columns} data={pendingUsers} />
            </CardContent>
          </Card>
        </div>
      )
    }
    ```
  </action>
  <verify>
    - `cat src/app/admin/users/page.tsx | grep "pending_approval"` confirms correct status filter
    - `cat src/app/admin/users/columns.tsx | grep "approveUser"` confirms approve action
    - `cat src/app/admin/users/columns.tsx | grep "rejectUser"` confirms reject action
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - /admin/users shows users with status: pending_approval
    - Table displays email, verified badge, request date
    - Approve and Reject buttons for each user
    - Toast notifications for action success/failure
    - Empty state when no pending users
  </done>
</task>

<task type="auto">
  <name>Task 3: Create approve/reject server actions</name>
  <files>
    src/app/admin/users/actions.ts
  </files>
  <action>
    Create server actions for approving and rejecting users with email notifications and audit logging.

    **src/app/admin/users/actions.ts:**
    ```typescript
    "use server"

    import { auth } from "@/auth"
    import { db } from "@/db"
    import { users, rejectedSignups } from "@/db/schema"
    import { eq, and, isNull } from "drizzle-orm"
    import { revalidatePath } from "next/cache"
    import { sendApprovalEmail } from "@/lib/email/send"
    { redirect } from "next/navigation"

    /**
     * Approve a pending user
     * - Updates status to approved
     * - Sends approval email notification
     * - Revalidates the admin users page
     */
    export async function approveUser(userId: string): Promise<void> {
      const session = await auth()

      // Verify admin role
      if (!session?.user || session.user.role !== "admin") {
        throw new Error("Unauthorized: Admin access required")
      }

      // Get the user
      const user = await db.query.users.findFirst({
        where: and(
          eq(users.id, userId),
          eq(users.status, "pending_approval"),
          isNull(users.deletedAt)
        ),
      })

      if (!user) {
        throw new Error("User not found or already processed")
      }

      // Update user status
      await db
        .update(users)
        .set({
          status: "approved",
          updatedAt: new Date(),
        })
        .where(eq(users.id, userId))

      // Send approval email (async, don't await to avoid blocking)
      sendApprovalEmail(user.email).catch((error) => {
        console.error("Failed to send approval email:", error)
      })

      // Revalidate the page to show updated data
      revalidatePath("/admin/users")
    }

    /**
     * Reject a pending user
     * - Logs rejection to rejected_signups table
     * - Soft deletes the user record
     * - Revalidates the admin users page
     */
    export async function rejectUser(
      userId: string,
      reason?: string
    ): Promise<void> {
      const session = await auth()

      // Verify admin role
      if (!session?.user || session.user.role !== "admin") {
        throw new Error("Unauthorized: Admin access required")
      }

      // Get the user
      const user = await db.query.users.findFirst({
        where: and(
          eq(users.id, userId),
          eq(users.status, "pending_approval"),
          isNull(users.deletedAt)
        ),
      })

      if (!user) {
        throw new Error("User not found or already processed")
      }

      // Log the rejection for audit purposes
      await db.insert(rejectedSignups).values({
        email: user.email,
        rejectedBy: session.user.id,
        rejectedAt: new Date(),
        reason: reason || null,
      })

      // Soft delete the user (don't hard delete - keep for records)
      await db
        .update(users)
        .set({
          status: "rejected",
          deletedAt: new Date(),
          updatedAt: new Date(),
        })
        .where(eq(users.id, userId))

      // Revalidate the page to show updated data
      revalidatePath("/admin/users")
    }

    /**
     * Get rejected signups for audit log (optional utility)
     */
    export async function getRejectedSignups() {
      const session = await auth()

      if (!session?.user || session.user.role !== "admin") {
        throw new Error("Unauthorized: Admin access required")
      }

      const rejected = await db.query.rejectedSignups.findMany({
        with: {
          rejectedBy: {
            columns: {
              email: true,
            },
          },
        },
        orderBy: (rejectedSignups, { desc }) => [desc(rejectedSignups.rejectedAt)],
      })

      return rejected
    }
    ```

    **Note:** The rejectedSignups table needs a relation to users. Update src/db/schema/rejected-signups.ts to add:
    ```typescript
    import { relations } from "drizzle-orm"
    import { users } from "./users"

    export const rejectedSignupsRelations = relations(rejectedSignups, ({ one }) => ({
      rejectedBy: one(users, {
        fields: [rejectedSignups.rejectedBy],
        references: [users.id],
      }),
    }))
    ```

    Also add the export to the schema index.
  </action>
  <verify>
    - `cat src/app/admin/users/actions.ts | grep "approveUser"` confirms approve action
    - `cat src/app/admin/users/actions.ts | grep "rejectUser"` confirms reject action
    - `cat src/app/admin/users/actions.ts | grep "sendApprovalEmail"` confirms email notification
    - `cat src/app/admin/users/actions.ts | grep "rejectedSignups"` confirms audit logging
    - `npx tsc --noEmit` passes
  </verify>
  <done>
    - approveUser sets status to approved, sends email
    - rejectUser logs to rejected_signups, soft-deletes user
    - Both actions verify admin role before executing
    - Both actions revalidate /admin/users page
    - getRejectedSignups utility for audit log viewing
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Complete admin approval workflow:
    - Admin layout with sidebar navigation
    - Admin dashboard showing pending counts
    - Pending users table with approve/reject buttons
    - Server actions for approve (sends email) and reject (logs to audit table)
  </what-built>
  <how-to-verify>
    1. Run `npm run dev` and open http://localhost:3000
    2. Sign up a new user at /signup (use a real email if you want to test email flow)
    3. Check email and click verification link
    4. Log in as admin (you'll need to manually set a user's role to 'admin' in the database for testing)
    5. Navigate to /admin/users
    6. Verify you see the pending user
    7. Click "Approve" and verify:
       - User disappears from pending list
       - User receives approval email (if SMTP configured)
       - User can now log in
    8. Sign up another user and verify email
    9. Click "Reject" and verify:
       - User disappears from pending list
       - Entry appears in rejected_signups table
  </how-to-verify>
  <resume-signal>Type "approved" if workflow works correctly, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
After all tasks complete:
1. Admin layout blocks non-admin access
2. /admin/users shows only pending_approval users
3. Approve button sends approval email and updates status
4. Reject button logs to rejected_signups and soft-deletes user
5. Data table properly displays pending users
6. Toast notifications show action results
</verification>

<success_criteria>
- /admin/* routes require admin role (redirects non-admins)
- Admin dashboard shows pending approval count
- /admin/users displays users with status: pending_approval
- Each pending user has Approve and Reject buttons
- Approve: status → approved, approval email sent
- Reject: logged to rejected_signups, user soft-deleted
- Server actions verify admin role before executing
- Page revalidates after approve/reject actions
- Toast notifications confirm action success/failure
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-05-SUMMARY.md`
</output>
