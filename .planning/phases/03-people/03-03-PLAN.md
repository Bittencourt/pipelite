---
phase: 03-people
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/app/people/person-dialog.tsx
  - src/app/people/delete-dialog.tsx
  - src/app/people/data-table.tsx
  - src/app/people/[id]/page.tsx
  - src/app/people/[id]/person-detail-client.tsx
  - src/app/organizations/[id]/page.tsx
autonomous: true

must_haves:
  truths:
    - "User can create a person with first name, last name, email, phone, notes, and optional organization link"
    - "User can edit a person's details including changing the linked organization"
    - "User can delete a person with a confirmation dialog"
    - "User can view full details of a person including their linked organization name"
    - "Organization detail page shows a list of people linked to that organization"
  artifacts:
    - path: "src/app/people/person-dialog.tsx"
      provides: "Create/edit person form dialog with organization select dropdown"
      contains: "PersonDialog"
    - path: "src/app/people/delete-dialog.tsx"
      provides: "Delete person confirmation dialog"
      contains: "DeleteDialog"
    - path: "src/app/people/[id]/page.tsx"
      provides: "Person detail page with all fields and linked org"
      contains: "PersonDetailPage"
    - path: "src/app/people/[id]/person-detail-client.tsx"
      provides: "Client component for edit/delete actions on person detail"
      contains: "PersonDetailClient"
    - path: "src/app/organizations/[id]/page.tsx"
      provides: "Updated org detail page with linked people section"
      contains: "people"
  key_links:
    - from: "src/app/people/person-dialog.tsx"
      to: "src/app/people/actions.ts"
      via: "calls createPerson/updatePerson server actions"
      pattern: "import.*(createPerson|updatePerson).*from.*actions"
    - from: "src/app/people/person-dialog.tsx"
      to: "src/components/ui/select.tsx"
      via: "uses Select component for organization dropdown"
      pattern: "import.*Select.*from.*ui/select"
    - from: "src/app/people/[id]/person-detail-client.tsx"
      to: "src/app/people/actions.ts"
      via: "calls deletePerson server action"
      pattern: "import.*deletePerson.*from.*actions"
    - from: "src/app/organizations/[id]/page.tsx"
      to: "src/db/schema/people.ts"
      via: "queries people linked to organization"
      pattern: "import.*people.*from.*db/schema"
---

<objective>
Create person CRUD dialogs, detail page, and linked people section on organization detail page.

Purpose: Complete the people feature with full CRUD UI (create, edit, delete dialogs + detail page) and demonstrate the organization-person relationship by showing linked people on the org detail page.
Output: Person create/edit dialog with org select, delete confirmation, detail page at /people/[id], and linked people list on /organizations/[id].
</objective>

<execution_context>
@/home/pedro/.claude/get-shit-done/workflows/execute-plan.md
@/home/pedro/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-people/03-RESEARCH.md
@.planning/phases/03-people/03-01-SUMMARY.md
@.planning/phases/03-people/03-02-SUMMARY.md

Key reference files (mirror these patterns exactly):
@src/app/organizations/organization-dialog.tsx
@src/app/organizations/delete-dialog.tsx
@src/app/organizations/[id]/page.tsx
@src/app/organizations/[id]/organization-detail-client.tsx
@src/app/organizations/data-table.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create person form dialog and delete dialog</name>
  <files>
    src/app/people/person-dialog.tsx
    src/app/people/delete-dialog.tsx
    src/app/people/data-table.tsx
  </files>
  <action>
    **Replace stub `src/app/people/person-dialog.tsx`** with full implementation mirroring organization-dialog.tsx:

    - `"use client"` directive
    - Imports: `useState`, `useEffect` from react; `useForm` from react-hook-form; `zodResolver` from @hookform/resolvers/zod; `z` from zod; Dialog components from `@/components/ui/dialog`; `Button`, `Input`, `Label`, `Textarea` from ui components; `Select`, `SelectContent`, `SelectItem`, `SelectTrigger`, `SelectValue` from `@/components/ui/select`; `Loader2` from lucide-react; `createPerson`, `updatePerson` from `./actions`; `toast` from sonner

    - Zod schema (same as in actions.ts for client-side validation):
      ```
      const personSchema = z.object({
        firstName: z.string().min(1, "First name is required").max(50),
        lastName: z.string().min(1, "Last name is required").max(50),
        email: z.string().email("Invalid email").optional().or(z.literal("")),
        phone: z.string().max(30).optional().or(z.literal("")),
        notes: z.string().max(2000).optional().or(z.literal("")),
        organizationId: z.string().optional().or(z.literal("")),
      })
      ```

    - Person interface for edit mode: `{ id, firstName, lastName, email, phone, notes, organizationId }`
    - Organization option type: `{ id: string; name: string }`

    - Props interface `PersonDialogProps`:
      - `open: boolean`
      - `onOpenChange: (open: boolean) => void`
      - `person?: Person | null` (for edit mode)
      - `organizations: OrganizationOption[]` (for the select dropdown)
      - `onSuccess: () => void`

    - Component structure matches organization-dialog.tsx exactly:
      - `isLoading` state, `isEditMode` flag
      - `useForm` with `zodResolver(personSchema)` and default values for all fields
      - `useEffect` resets form when dialog opens (same pattern as org dialog)
      - `onSubmit` calls `createPerson` or `updatePerson`, shows toast, calls `onSuccess`
      - `handleClose` resets form and closes dialog

    - Form fields (inside `<form onSubmit={handleSubmit(onSubmit)}`):
      1. **First Name** (required, `<Input>` with `{...register("firstName")}`)
      2. **Last Name** (required, `<Input>` with `{...register("lastName")}`)
      3. **Email** (optional, `<Input>` type="email")
      4. **Phone** (optional, `<Input>`)
      5. **Organization** (optional, `<Select>` dropdown):
         - Use shadcn Select component
         - Since `react-hook-form` register doesn't work with radix Select, use `Controller` from react-hook-form OR manually wire with `setValue`/`watch`:
           ```
           const organizationId = watch("organizationId")
           ```
           And in the Select:
           ```
           <Select
             value={organizationId || ""}
             onValueChange={(value) => setValue("organizationId", value === "none" ? "" : value)}
             disabled={isLoading}
           >
             <SelectTrigger>
               <SelectValue placeholder="Select an organization (optional)" />
             </SelectTrigger>
             <SelectContent>
               <SelectItem value="none">No organization</SelectItem>
               {organizations.map((org) => (
                 <SelectItem key={org.id} value={org.id}>{org.name}</SelectItem>
               ))}
             </SelectContent>
           </Select>
           ```
         - Include a "No organization" option that sets organizationId to empty string
      6. **Notes** (optional, `<Textarea>` with rows={4})

    - DialogFooter: Cancel + Submit buttons (same pattern as org dialog)
    - Button text: "Create Person" / "Save Changes"

    **Replace stub `src/app/people/delete-dialog.tsx`** with full implementation mirroring organizations/delete-dialog.tsx:
    - Same structure as org delete-dialog but with "Delete Person" title
    - Props: `open`, `onOpenChange`, `personName: string` (display as "firstName lastName"), `onConfirm`, `isLoading`
    - Confirmation text: `Are you sure you want to delete "{personName}"? This action cannot be undone.`

    **Update `src/app/people/data-table.tsx`** to wire the real dialogs:
    - Replace stub imports with real component imports (PersonDialog, DeleteDialog)
    - Ensure `PersonDialog` receives `organizations` prop from DataTable props
    - Ensure `DeleteDialog` receives `personName` as `\`${personToDelete.firstName} ${personToDelete.lastName}\``
    - Ensure everything compiles and works end-to-end

    Run `npx tsc --noEmit` to verify.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. PersonDialog renders form with firstName, lastName, email, phone, organization select, notes fields
    3. DeleteDialog renders confirmation with person name
    4. DataTable wires Add Person button -> PersonDialog (create mode)
    5. DataTable wires Edit action -> PersonDialog (edit mode with person data)
    6. DataTable wires Delete action -> DeleteDialog
  </verify>
  <done>
    Person create/edit dialog works with organization dropdown. Delete confirmation dialog works. Data table wires all three operations correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create person detail page and add linked people to org detail</name>
  <files>
    src/app/people/[id]/page.tsx
    src/app/people/[id]/person-detail-client.tsx
    src/app/organizations/[id]/page.tsx
  </files>
  <action>
    **Create `src/app/people/[id]/page.tsx`** mirroring organizations/[id]/page.tsx:
    - Server component (no `"use client"`)
    - Imports: `db` from `@/db`, `people`, `organizations`, `users` from `@/db/schema`, `eq`, `and`, `isNull` from `drizzle-orm`, `notFound` from `next/navigation`, Card components, icons (`Users`, `Mail`, `Phone`, `Building2`, `Calendar`, `User`, `FileText`), `PersonDetailClient`
    - Interface `PageProps { params: Promise<{ id: string }> }` -- use async params pattern
    - `getPerson(id)` function:
      ```
      db.select({
        id: people.id,
        firstName: people.firstName,
        lastName: people.lastName,
        email: people.email,
        phone: people.phone,
        notes: people.notes,
        organizationId: people.organizationId,
        organizationName: organizations.name,
        ownerName: users.name,
        createdAt: people.createdAt,
      })
      .from(people)
      .leftJoin(organizations, and(eq(people.organizationId, organizations.id), isNull(organizations.deletedAt)))
      .leftJoin(users, eq(people.ownerId, users.id))
      .where(and(eq(people.id, id), isNull(people.deletedAt)))
      .limit(1)
      ```
      Return null if empty, otherwise the person data.
    - Also fetch `getOrganizationsForSelect()` (same query as in list page) for the edit dialog
    - Page component: `const { id } = await params`, fetch person, notFound() if null
    - Render `PersonDetailClient` at top (passing person + organizations for edit dialog)
    - Card with "Person Details" title and `Users` icon:
      - Grid layout (md:grid-cols-2) with detail fields:
        - **Name**: Shows "firstName lastName" with Users icon
        - **Email**: Shows email or "Not specified", with mailto link if email exists
        - **Phone**: Shows phone or "Not specified"
        - **Organization**: If organizationName exists, show as link to `/organizations/${organizationId}` with Building2 icon. If null, show "No organization"
        - **Owner**: Shows ownerName or "Unknown"
        - **Created**: Formatted date
      - Notes section below grid (same pattern as org detail) if notes exist

    **Create `src/app/people/[id]/person-detail-client.tsx`** mirroring organization-detail-client.tsx:
    - `"use client"` directive
    - Imports: `useState` from react, `useRouter`, `Button`, icons (Pencil, Trash2, ArrowLeft), `PersonDialog`, `DeleteDialog`, `deletePerson`, `toast`
    - Person interface: `{ id, firstName, lastName, email, phone, notes, organizationId, organizationName, ownerName, createdAt }`
    - Props: `{ person: Person, organizations: { id: string; name: string }[] }`
    - Same state + handlers pattern as organization-detail-client:
      - `editDialogOpen`, `deleteDialogOpen`, `isDeleting`
      - `handleDelete` calls `deletePerson(person.id)`, toast success, navigate to `/people`
      - `handleEditSuccess` closes dialog and refreshes
    - Render:
      - Back button: "Back to People" -> `/people`
      - Title: `{person.firstName} {person.lastName}`
      - Edit + Delete buttons
      - PersonDialog (edit mode, passing person data + organizations)
      - DeleteDialog (passing person full name)

    **Update `src/app/organizations/[id]/page.tsx`** to show linked people:
    - Add import for `people` from `@/db/schema` and `desc` from `drizzle-orm`
    - Add import for `Link` from `next/link` and `Users` icon
    - Add `getLinkedPeople(organizationId)` function:
      ```
      db.select({
        id: people.id,
        firstName: people.firstName,
        lastName: people.lastName,
        email: people.email,
        phone: people.phone,
      })
      .from(people)
      .where(and(eq(people.organizationId, organizationId), isNull(people.deletedAt)))
      .orderBy(desc(people.createdAt))
      ```
    - In the page component, call `getLinkedPeople(id)` alongside `getOrganization(id)`
    - After the existing Card, add a new Card with title "People" and `Users` icon:
      - If linkedPeople is empty: show "No people linked to this organization" muted text
      - If linkedPeople exists: render a simple list/table showing each person as a link to `/people/${person.id}` with their name and email
      - Each person row: `Users` icon + Link with "firstName lastName" + email in muted text

    Run `npx tsc --noEmit` to verify everything compiles.
  </action>
  <verify>
    1. `npx tsc --noEmit` passes
    2. Person detail page renders at /people/[id] with all fields
    3. Person detail shows organization as clickable link (when linked)
    4. Edit button opens PersonDialog in edit mode with organization select
    5. Delete button opens DeleteDialog, confirms, soft-deletes, redirects to /people
    6. Organization detail page shows a "People" section listing linked contacts
  </verify>
  <done>
    Person detail page shows all fields with organization link. Edit/delete work from detail page. Organization detail page displays linked people with links to their detail pages.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript errors
2. Create a person via "Add Person" button -- form includes org dropdown, success toast, person appears in list
3. Click person name in list -> navigates to /people/[id] detail page with all fields
4. Edit person from detail page -> dialog opens with current data including org select, save updates correctly
5. Delete person from detail page -> confirmation dialog, soft delete, redirect to /people
6. View organization detail page -> see linked people section showing contacts linked to that org
7. Create/edit person with organization link -> org detail page shows the person in linked people section
</verification>

<success_criteria>
- Person create dialog with org select dropdown creates people successfully
- Person edit dialog pre-fills all fields including organization selection
- Person delete with confirmation dialog soft-deletes and redirects
- Person detail page shows all fields with organization as clickable link
- Organization detail page lists linked people with links to their detail pages
</success_criteria>

<output>
After completion, create `.planning/phases/03-people/03-03-SUMMARY.md`
</output>
