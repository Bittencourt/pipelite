---
phase: 02-organizations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/organizations.ts
  - src/db/schema/_relations.ts
  - src/db/schema/index.ts
  - src/app/organizations/actions.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Organization data can be stored with name, website, industry, notes, and owner"
    - "Organizations are linked to users via ownerId foreign key"
    - "CRUD operations for organizations exist as server actions"
  artifacts:
    - path: "src/db/schema/organizations.ts"
      provides: "Organization data model"
      contains: "pgTable('organizations'"
    - path: "src/app/organizations/actions.ts"
      provides: "CRUD server actions"
      exports: ["createOrganization", "updateOrganization", "deleteOrganization"]
  key_links:
    - from: "src/db/schema/_relations.ts"
      to: "src/db/schema/organizations.ts"
      via: "import and relations"
    - from: "src/app/organizations/actions.ts"
      to: "src/db/schema/organizations.ts"
      via: "db.insert/update/delete"
---

<objective>
Create the database schema for organizations and the server actions for CRUD operations.

Purpose: Establish the data layer for organization management before building the UI.
Output: Organization schema with user relationship, and server actions for all CRUD operations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Phase 1 patterns to follow
@src/db/schema/users.ts
@src/db/schema/_relations.ts
@src/db/schema/index.ts
@src/app/admin/users/actions.ts
@src/db/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organizations database schema</name>
  <files>src/db/schema/organizations.ts, src/db/schema/_relations.ts, src/db/schema/index.ts</files>
  <action>
    Create the organizations table schema following existing patterns from users.ts:
    
    1. Create `src/db/schema/organizations.ts`:
       - Import `pgTable, text, timestamp` from drizzle-orm/pg-core
       - Create `organizations` table with:
         - `id`: text, primary key, default crypto.randomUUID()
         - `name`: text, not null
         - `website`: text, nullable (optional website URL)
         - `industry`: text, nullable (optional industry classification)
         - `notes`: text, nullable (optional notes about the organization)
         - `ownerId`: text, not null, references users.id
         - `createdAt`: timestamp, defaultNow(), not null
         - `updatedAt`: timestamp, defaultNow(), not null
         - `deletedAt`: timestamp, nullable (soft delete pattern)
       - Export the `organizations` table
    
    2. Update `src/db/schema/_relations.ts`:
       - Import `organizations` from "./organizations"
       - Add `organizationsRelations`: organizations has one `owner` (user)
       - Add `usersRelations`: users has many `organizations` (owned organizations)
    
    3. Update `src/db/schema/index.ts`:
       - Add `export * from "./organizations"` before the _relations export
    
    Pattern notes:
    - Follow exact style from users.ts (same imports, same $defaultFn pattern)
    - Use text IDs matching the users table pattern
    - Foreign key naming: `ownerId` references `users.id`
  </action>
  <verify>
    npx tsc --noEmit passes
    npx drizzle-kit push --dry-run shows organizations table would be created
  </verify>
  <done>
    Organizations schema file exists with all fields
    Relations file includes organizations relations
    Index file exports organizations
    TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create organizations server actions</name>
  <files>src/app/organizations/actions.ts</files>
  <action>
    Create server actions for organization CRUD following the pattern from src/app/admin/users/actions.ts:
    
    Create `src/app/organizations/actions.ts`:
    
    1. Imports:
       - "use server" directive at top
       - revalidatePath from next/cache
       - redirect from next/navigation
       - db from "@/db"
       - organizations schema from "@/db/schema/organizations"
       - eq, and, isNull from drizzle-orm
       - auth from "@/auth"
       - z from zod
    
    2. Validation schemas:
       - organizationSchema: z.object with name (min 1, max 100), website (optional url), industry (optional, max 50), notes (optional, max 2000)
    
    3. createOrganization action:
       - Validate user is authenticated (use auth())
       - Validate input with organizationSchema
       - Insert into organizations table with ownerId from session
       - Revalidate /organizations path
       - Return { success: true, id: organization.id } or { success: false, error: string }
    
    4. updateOrganization action:
       - Validate user is authenticated
       - Validate input (id + partial schema)
       - Verify organization exists and user owns it (ownerId matches session user)
       - Update organization with validated data and updatedAt: new Date()
       - Revalidate /organizations and /organizations/[id] paths
       - Return { success: true } or { success: false, error: string }
    
    5. deleteOrganization action:
       - Validate user is authenticated
       - Verify organization exists and user owns it
       - Soft delete: set deletedAt to new Date() (do NOT hard delete)
       - Revalidate /organizations path
       - Return { success: true } or { success: false, error: string }
    
    Error handling:
       - Return { success: false, error: "Not authenticated" } if no session
       - Return { success: false, error: "Organization not found" } if not exists
       - Return { success: false, error: "Not authorized" } if user doesn't own org
       - Return { success: false, error: validation error message } for invalid input
  </action>
  <verify>
    npx tsc --noEmit passes
    Actions file exports createOrganization, updateOrganization, deleteOrganization
  </verify>
  <done>
    Server actions file exists with all three CRUD operations
    All actions check authentication
    Update/delete actions verify ownership
    Delete uses soft delete pattern
    TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- Organizations schema matches requirements (name, website, industry, notes, ownerId, timestamps, soft delete)
- Relations properly link users and organizations
- Server actions handle auth, validation, and ownership checks
- Soft delete pattern consistent with users table
</verification>

<success_criteria>
- `npm run build` succeeds
- Organizations table can be created with `npm run db:push`
- createOrganization, updateOrganization, deleteOrganization are exported and type-safe
</success_criteria>

<output>
After completion, create `.planning/phases/02-organizations/02-01-SUMMARY.md`
</output>
