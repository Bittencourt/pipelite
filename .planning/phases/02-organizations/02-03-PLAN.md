---
phase: 02-organizations
plan: 03
type: execute
wave: 3
depends_on: [02-02]
files_modified:
  - src/app/organizations/organization-dialog.tsx
  - src/app/organizations/delete-dialog.tsx
  - src/app/organizations/[id]/page.tsx
  - src/app/organizations/page.tsx
  - src/app/organizations/data-table.tsx
  - src/app/organizations/columns.tsx
autonomous: true
user_setup: []

must_haves:
  truths:
    - "User can create a new organization with name and basic details"
    - "User can view full details of a single organization"
    - "User can edit organization details"
    - "User can delete an organization with confirmation"
  artifacts:
    - path: "src/app/organizations/organization-dialog.tsx"
      provides: "Create/edit organization form"
      contains: "Dialog"
    - path: "src/app/organizations/delete-dialog.tsx"
      provides: "Delete confirmation dialog"
    - path: "src/app/organizations/[id]/page.tsx"
      provides: "Organization detail view"
      min_lines: 50
  key_links:
    - from: "src/app/organizations/data-table.tsx"
      to: "src/app/organizations/organization-dialog.tsx"
      via: "Add button opens dialog"
    - from: "src/app/organizations/[id]/page.tsx"
      to: "src/app/organizations/actions.ts"
      via: "server actions for edit/delete"
---

<objective>
Create the organization form dialog for create/edit, delete confirmation dialog, and organization detail page.

Purpose: Complete the full CRUD experience for organizations with intuitive dialogs and a detailed view.
Output: Working create, edit, and delete functionality with proper dialogs and detail page.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior plans
@.planning/phases/02-organizations/02-01-SUMMARY.md
@.planning/phases/02-organizations/02-02-SUMMARY.md

# Patterns to follow
@src/app/(auth)/signup/page.tsx
@src/components/api-key-dialog.tsx
@src/app/admin/users/columns.tsx
@src/db/schema/organizations.ts
@src/app/organizations/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create organization form dialog for create/edit</name>
  <files>src/app/organizations/organization-dialog.tsx, src/app/organizations/data-table.tsx, src/app/organizations/columns.tsx</files>
  <action>
    Create a reusable dialog for creating and editing organizations:
    
    1. Create `src/app/organizations/organization-dialog.tsx`:
       - "use client" directive
       - Imports: useState from react, useForm, zodResolver from react-hook-form, z from zod, Dialog components from shadcn/ui, Button, Input, Label, Loader2 from lucide-react
       - Props: open (boolean), onOpenChange (callback), organization (optional - for edit mode), onSuccess (callback)
       - Schema: z.object with name (min 1, max 100), website (optional url), industry (optional, max 50), notes (optional, max 2000)
       - State: isLoading, error
       - Form: react-hook-form with zodResolver
       - Mode detection: if organization prop provided, it's edit mode
       - onSubmit:
         - Set isLoading true
         - Call createOrganization or updateOrganization based on mode
         - If success: call onSuccess, close dialog, reset form
         - If error: set error message
       - Dialog content:
         - Title: "Add Organization" or "Edit Organization"
         - Form fields: name (required), website (optional), industry (optional), notes (optional textarea)
         - Submit button with loading state
         - Cancel button
    
    2. Update `src/app/organizations/data-table.tsx`:
       - Add state for dialog: const [dialogOpen, setDialogOpen] = useState(false)
       - Add state for editing: const [editingOrg, setEditingOrg] = useState(null)
       - Add OrganizationDialog import
       - Wire "Add Organization" button to: setDialogOpen(true), setEditingOrg(null)
       - Add OrganizationDialog component with:
         - open={dialogOpen}
         - onOpenChange={setDialogOpen}
         - organization={editingOrg}
         - onSuccess={() => { setDialogOpen(false); refresh(); }}
    
    3. Update `src/app/organizations/columns.tsx`:
       - Update actions column to receive onEdit and onDelete callbacks as props via table meta
       - Edit button: calls onEdit with the organization data
       - Keep delete button (will be wired in Task 2)
       - Pass these callbacks through the columns definition or use table.meta pattern
  </action>
  <verify>
    npx tsc --noEmit passes
    Dialog opens from "Add Organization" button
    Dialog closes on cancel or success
    Form validation works
  </verify>
  <done>
    OrganizationDialog component exists with form fields
    Dialog opens for create mode from "Add Organization" button
    Form validates input and calls server actions
    Success creates organization and refreshes list
    TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Create delete confirmation dialog and organization detail page</name>
  <files>src/app/organizations/delete-dialog.tsx, src/app/organizations/[id]/page.tsx, src/app/organizations/data-table.tsx, src/app/organizations/columns.tsx</files>
  <action>
    Create delete confirmation and detail page:
    
    1. Create `src/app/organizations/delete-dialog.tsx`:
       - "use client" directive
       - Imports: Dialog components, Button, AlertTriangle from lucide-react
       - Props: open, onOpenChange, organizationName, onConfirm, isLoading
       - Dialog content:
         - Alert triangle icon (destructive color)
         - Title: "Delete Organization"
         - Description: "Are you sure you want to delete \"{organizationName}\"? This action cannot be undone."
         - Cancel button
         - Delete button (destructive variant, with loading state)
    
    2. Create `src/app/organizations/[id]/page.tsx`:
       - Server component
       - Imports: db, organizations, users, eq, isNull, not found from next/navigation, Card components, Button, Badge, ArrowLeft, Pencil, Trash2 from lucide-react
       - Props: { params: { id: string } }
       - Fetch organization by id with owner info (join users)
       - If not found or deleted (deletedAt not null): call notFound()
       - Render:
         - Back link to /organizations
         - Header with name and edit/delete buttons
         - Card with details: Name, Website (with link), Industry, Notes, Owner, Created date
         - Use grid layout for detail fields
         - Clicking Edit opens organization dialog (pass organization data)
         - Clicking Delete opens delete confirmation
    
       Note: For the detail page, you'll need to make it a client component or use a separate client component for the action buttons since dialogs need client-side state. Consider creating a separate `organization-detail-client.tsx` for the interactive parts.
    
    3. Wire delete in `src/app/organizations/data-table.tsx`:
       - Add state for delete dialog: const [deleteDialogOpen, setDeleteDialogOpen] = useState(false)
       - Add state for org to delete: const [orgToDelete, setOrgToDelete] = useState(null)
       - Import and add DeleteDialog component
       - Pass onEdit and onDelete to table meta:
         - onEdit: (org) => { setEditingOrg(org); setDialogOpen(true); }
         - onDelete: (org) => { setOrgToDelete(org); setDeleteDialogOpen(true); }
       - Wire DeleteDialog's onConfirm to call deleteOrganization action
    
    4. Update `src/app/organizations/columns.tsx`:
       - Access onEdit and onDelete from table.options.meta
       - Wire buttons to call these callbacks with row.original
  </action>
  <verify>
    npx tsc --noEmit passes
    Delete dialog opens from delete button
    Delete dialog confirms before deleting
    Detail page shows organization information
    Detail page has edit and delete actions
  </verify>
  <done>
    DeleteDialog component exists with confirmation UI
    Delete soft-deletes organization and refreshes list
    Detail page at /organizations/[id] shows full organization info
    Detail page has edit and delete functionality
    TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
- Creating organization from list page works
- Editing organization from list or detail page works
- Deleting organization from list or detail page works with confirmation
- Detail page shows all organization fields
- All navigation between list, detail, create, edit works
</verification>

<success_criteria>
- `npm run build` succeeds
- Full CRUD cycle works: create → view detail → edit → delete
- All dialogs have proper loading and error states
- Soft delete pattern confirmed (deletedAt set, not hard delete)
</success_criteria>

<output>
After completion, create `.planning/phases/02-organizations/02-03-SUMMARY.md`
</output>
