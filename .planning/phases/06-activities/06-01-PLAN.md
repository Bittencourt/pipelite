---
phase: 06-activities
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/activity-types.ts
  - src/db/schema/activities.ts
  - src/db/schema/_relations.ts
  - src/db/schema/index.ts
  - src/app/activities/actions.ts
  - drizzle/seed-activity-types.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Activity types exist in the database (Call, Meeting, Task, Email)"
    - "Activities can be created with title, type, due date, and optional deal link"
    - "Activities can be updated and deleted"
    - "Activities can be marked as complete/incomplete"
  artifacts:
    - path: "src/db/schema/activity-types.ts"
      provides: "ActivityTypes table definition"
      contains: "export const activityTypes"
    - path: "src/db/schema/activities.ts"
      provides: "Activities table with FKs to activityTypes, deals, users"
      contains: "export const activities"
      min_lines: 25
    - path: "src/db/schema/_relations.ts"
      provides: "Drizzle relations for activities"
      contains: "activitiesRelations"
    - path: "src/app/activities/actions.ts"
      provides: "CRUD server actions for activities"
      exports: ["createActivity", "updateActivity", "deleteActivity", "toggleActivityCompletion"]
  key_links:
    - from: "src/db/schema/activities.ts"
      to: "src/db/schema/activity-types.ts"
      via: "typeId foreign key"
      pattern: "references\\(\\(\\) => activityTypes"
    - from: "src/db/schema/activities.ts"
      to: "src/db/schema/deals.ts"
      via: "dealId foreign key (nullable)"
      pattern: "references\\(\\(\\) => deals"
    - from: "src/app/activities/actions.ts"
      to: "src/db/schema/activities.ts"
      via: "db.insert/update/delete"
      pattern: "db\\.(insert|update|delete)\\(activities\\)"
---

<objective>
Create the data layer for activities: database schema, relations, CRUD server actions, and seed data for default activity types.

Purpose: Enable storage and manipulation of follow-up activities linked to deals.
Output: Complete data foundation for activity tracking with type system and CRUD operations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-activities/06-RESEARCH.md

# Reference patterns from existing codebase
@src/db/schema/deals.ts
@src/db/schema/_relations.ts
@src/app/deals/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity types and activities schemas</name>
  <files>
    src/db/schema/activity-types.ts
    src/db/schema/activities.ts
  </files>
  <action>
Create two schema files following existing patterns from deals.ts:

**src/db/schema/activity-types.ts:**
- Table: `activity_types` with columns:
  - `id`: text, primary key, crypto.randomUUID()
  - `name`: text, not null (e.g., "Call", "Meeting", "Task", "Email")
  - `icon`: text, nullable (Lucide icon name like "Phone", "Users", "CheckSquare", "Mail")
  - `color`: text, nullable (hex color like "#3B82F6")
  - `isDefault`: boolean, default false (marks system default types)
  - `createdAt`: timestamp, defaultNow()

**src/db/schema/activities.ts:**
- Table: `activities` with columns:
  - `id`: text, primary key, crypto.randomUUID()
  - `title`: text, not null
  - `typeId`: text, not null, references activityTypes.id
  - `dealId`: text, nullable, references deals.id (optional link)
  - `ownerId`: text, not null, references users.id
  - `dueDate`: timestamp, not null
  - `completedAt`: timestamp, nullable (null = not done, timestamp = done)
  - `notes`: text, nullable
  - `createdAt`: timestamp, defaultNow()
  - `updatedAt`: timestamp, defaultNow()
  - `deletedAt`: timestamp, nullable (soft delete pattern)

Import users from "./users" and deals from "./deals" for FK references.

DO NOT add relations in these files - use _relations.ts (Task 2).
</action>
  <verify>
    - `cat src/db/schema/activity-types.ts` shows table with id, name, icon, color, isDefault, createdAt
    - `cat src/db/schema/activities.ts` shows table with id, title, typeId, dealId, ownerId, dueDate, completedAt, notes, timestamps, deletedAt
  </verify>
  <done>
    - activity-types.ts exists with ActivityTypes table
    - activities.ts exists with Activities table and proper FKs
  </done>
</task>

<task type="auto">
  <name>Task 2: Add activity relations and exports</name>
  <files>
    src/db/schema/_relations.ts
    src/db/schema/index.ts
  </files>
  <action>
Update _relations.ts to add relations for activities:

1. Import activityTypes and activities at top
2. Add `activityTypesRelations`: one-to-many from activityTypes to activities
3. Add `activitiesRelations` with:
   - `type`: one-to-one to activityTypes (via typeId)
   - `deal`: one-to-one to deals (via dealId, optional)
   - `owner`: one-to-one to users (via ownerId)
4. Add `activities: many(activities)` to usersRelations
5. Add `activities: many(activities)` to dealsRelations (if not exists)

Update src/db/schema/index.ts:
- Export `activityTypes` from "./activity-types"
- Export `activities` from "./activities"

Follow existing pattern in _relations.ts exactly.
</action>
  <verify>
    - `grep -A10 "activitiesRelations" src/db/schema/_relations.ts` shows type, deal, owner relations
    - `grep "activities" src/db/schema/index.ts` shows both exports
  </verify>
  <done>
    - _relations.ts has activitiesRelations and activityTypesRelations
    - index.ts exports both schemas
  </done>
</task>

<task type="auto">
  <name>Task 3: Create activity CRUD server actions</name>
  <files>
    src/app/activities/actions.ts
  </files>
  <action>
Create server actions file at src/app/activities/actions.ts with the following functions:

**Imports needed:**
- "use server" directive
- auth from "@/auth"
- db from "@/db"
- activities, activityTypes, deals from "@/db/schema"
- eq, and, isNull, desc from "drizzle-orm"
- revalidatePath from "next/cache"
- z from "zod"

**Schemas:**
- activitySchema: title (1-200 chars), typeId (required), dealId (optional/nullable), dueDate (date), notes (optional, max 2000 chars)

**Functions:**

1. `createActivity(data)`: 
   - Auth check, return error if not authenticated
   - Validate with zod schema
   - Verify activity type exists
   - If dealId provided, verify deal exists and not deleted
   - Insert activity with ownerId from session
   - Return { success: true, id } or { success: false, error }

2. `updateActivity(id, data)`:
   - Auth check
   - Find activity, verify ownership
   - Validate data
   - If typeId changed, verify new type exists
   - If dealId changed, verify deal exists
   - Update with updatedAt timestamp
   - Return { success: true } or { success: false, error }

3. `deleteActivity(id)`:
   - Auth check
   - Find activity, verify ownership
   - Soft delete (set deletedAt to now)
   - Return { success: true } or { success: false, error }

4. `toggleActivityCompletion(id)`:
   - Auth check
   - Find activity, verify ownership
   - Toggle: if completedAt is null, set to now; if set, set to null
   - Return { success: true } or { success: false, error }

5. `getActivities(filters?)`:
   - Auth check
   - Query activities with relations (type, deal, owner)
   - Filter out deleted (deletedAt is null)
   - Apply optional filters: typeId, dealId, ownerId, completed status
   - Order by dueDate ascending
   - Return array of activities

6. `getActivityById(id)`:
   - Auth check
   - Query single activity with relations
   - Return activity or null

7. `getActivityTypes()`:
   - Auth check
   - Query all activity types ordered by name
   - Return array

All functions revalidatePath("/activities") on success.

Follow the exact pattern from src/app/deals/actions.ts for auth, validation, and error handling.
</action>
  <verify>
    - `grep -c "export async function" src/app/activities/actions.ts` returns 7 or more
    - `grep "createActivity\|updateActivity\|deleteActivity\|toggleActivityCompletion" src/app/activities/actions.ts` shows all 4 functions
    - `npm run build` passes without errors (type check)
  </verify>
  <done>
    - actions.ts has all CRUD functions with proper auth and validation
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 4: Create seed script for default activity types</name>
  <files>
    drizzle/seed-activity-types.ts
  </files>
  <action>
Create a seed script at drizzle/seed-activity-types.ts that inserts default activity types:

**Default types to seed:**
1. Call - icon: "Phone", color: "#3B82F6" (blue), isDefault: true
2. Meeting - icon: "Users", color: "#10B981" (green), isDefault: true
3. Task - icon: "CheckSquare", color: "#F59E0B" (amber), isDefault: true
4. Email - icon: "Mail", color: "#8B5CF6" (purple), isDefault: true

**Implementation:**
- Import db from "@/db"
- Import activityTypes from "@/db/schema"
- Use db.insert().values() with onConflictDoNothing() to avoid duplicates
- Log success/failure
- Wrap in async function and call it

This script should be idempotent (safe to run multiple times).

Add npm script to package.json:
```json
"db:seed-activities": "tsx drizzle/seed-activity-types.ts"
```
</action>
  <verify>
    - `cat drizzle/seed-activity-types.ts` shows 4 activity types with icons and colors
    - `grep "db:seed-activities" package.json` shows the npm script
  </verify>
  <done>
    - Seed script exists and can populate default activity types
    - npm script available for easy execution
  </done>
</task>

<task type="auto">
  <name>Task 5: Run database migration</name>
  <files>
    drizzle/meta/*.sql
  </files>
  <action>
Generate and apply database migration:

1. Run `npx drizzle-kit generate` to create migration files
2. Review the generated SQL to ensure it creates both tables with correct constraints
3. Run `npx drizzle-kit migrate` to apply migration (if DB available)
4. Run `npm run db:seed-activities` to seed default types

If database is not available, note in summary that migration needs to be run manually later.
</action>
  <verify>
    - `ls drizzle/*.sql` shows new migration file
    - Migration SQL contains CREATE TABLE for activity_types and activities
  </verify>
  <done>
    - Migration generated for both tables
    - Default activity types seeded (or noted as pending)
  </done>
</task>

</tasks>

<verification>
- All 5 tasks completed
- TypeScript compiles: `npm run build`
- Schema files follow existing patterns
- Relations properly defined
- CRUD actions have auth checks and validation
- Seed script ready for default types
</verification>

<success_criteria>
- [ ] activity-types.ts created with ActivityTypes table
- [ ] activities.ts created with Activities table and FKs
- [ ] _relations.ts has activitiesRelations and activityTypesRelations
- [ ] index.ts exports both schemas
- [ ] actions.ts has createActivity, updateActivity, deleteActivity, toggleActivityCompletion
- [ ] actions.ts has getActivities, getActivityById, getActivityTypes
- [ ] Seed script creates 4 default activity types
- [ ] Migration generated
- [ ] TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-activities/06-01-SUMMARY.md`
</output>
