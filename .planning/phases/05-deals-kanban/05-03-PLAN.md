---
phase: 05-deals-kanban
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - src/app/deals/page.tsx
  - src/app/deals/kanban-board.tsx
  - src/app/deals/kanban-column.tsx
  - src/app/deals/deal-card.tsx
autonomous: false

must_haves:
  truths:
    - "User sees deals organized by pipeline stages in columns"
    - "User can drag deals between stages to update status"
    - "User can expand card inline to see quick details"
    - "Stage headers show deal count and total value"
    - "Won/Lost stages appear in collapsed footer row"
    - "User can switch between pipelines via dropdown"
  artifacts:
    - path: "src/app/deals/page.tsx"
      provides: "Server component fetching deals and passing to client"
    - path: "src/app/deals/kanban-board.tsx"
      provides: "DndContext with closestCorners, drag handlers, DragOverlay"
      contains: "DndContext"
    - path: "src/app/deals/kanban-column.tsx"
      provides: "Column with useDroppable for empty column support"
      contains: "useDroppable"
    - path: "src/app/deals/deal-card.tsx"
      provides: "Card with useSortable, inline expansion, edit/delete buttons"
      contains: "useSortable"
  key_links:
    - from: "kanban-board.tsx"
      to: "updateDealStage action"
      via: "handleDragEnd"
      pattern: "updateDealStage"
    - from: "kanban-column.tsx"
      to: "useDroppable"
      via: "@dnd-kit/core import"
      pattern: "useDroppable"
    - from: "deal-card.tsx"
      to: "deal-dialog.tsx"
      via: "import DealDialog"
    - from: "page.tsx"
      to: "database"
      via: "db.query"
      pattern: "db\\.query"
---

<objective>
Create the kanban board UI with drag-and-drop deal management, inline card expansion, and pipeline/stage organization. This is the primary interface for viewing and managing deals.

Purpose: Enable visual deal management through drag-drop kanban interface as the core user experience.
Output: Kanban board page with DndContext, columns with useDroppable, cards with useSortable and inline expansion.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deals-kanban/05-CONTEXT.md
@.planning/phases/05-deals-kanban/05-RESEARCH.md

# Prior work
@.planning/phases/05-deals-kanban/05-01-SUMMARY.md
@.planning/phases/05-deals-kanban/05-02-SUMMARY.md

# Existing patterns to follow
@src/app/admin/pipelines/[id]/stage-configurator.tsx
@src/lib/stage-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deals page server component</name>
  <files>src/app/deals/page.tsx</files>
  <action>
Create the server component that fetches all data needed for the kanban board.

**Implementation (src/app/deals/page.tsx):**

```typescript
import { auth } from "@/auth"
import { db } from "@/db"
import { deals, stages, pipelines, organizations, people } from "@/db/schema"
import { eq, and, isNull, asc, inArray } from "drizzle-orm"
import { redirect } from "next/navigation"
import { KanbanBoard } from "./kanban-board"
import { Button } from "@/components/ui/button"
import { Plus } from "lucide-react"
```

**Data fetching:**
1. Get current user session (redirect if not authenticated)
2. Fetch all pipelines (not deleted, ordered by isDefault then name)
3. Fetch all stages for all pipelines (ordered by position)
4. Fetch all deals (not deleted, with organization and person relations, ordered by position)
5. Fetch all organizations (not deleted, for dropdown)
6. Fetch all people (not deleted, for dropdown)

**Pass to KanbanBoard:**
- selectedPipelineId (default to isDefault pipeline, or first pipeline)
- all pipelines (id, name)
- stages for selected pipeline
- deals grouped by stage (as object: { [stageId]: Deal[] })
- organizations for dropdown
- people for dropdown

**Page structure:**
- Header with "Deals" title and "Add Deal" button
- Pipeline selector dropdown (above kanban)
- KanbanBoard client component
- "Add Deal" button opens DealDialog in create mode

**Group deals by stage:**
Transform flat deals array into object keyed by stageId, each containing array of deals sorted by position.
</action>
  <verify>
    TypeScript compiles, page renders without errors
  </verify>
  <done>
    Server component fetches and passes all data to KanbanBoard client component
  </done>
</task>

<task type="auto">
  <name>Task 2: Create kanban board client component</name>
  <files>src/app/deals/kanban-board.tsx</files>
  <action>
Create the main kanban board client component with DndContext and drag handlers.

**Implementation following RESEARCH.md Pattern 1 and stage-configurator.tsx patterns:**

**Key imports:**
```typescript
"use client"

import { useState } from "react"
import {
  DndContext,
  DragOverlay,
  closestCorners,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragStartEvent,
  DragEndEvent,
  DragOverEvent,
} from "@dnd-kit/core"
import {
  SortableContext,
  verticalListSortingStrategy,
  sortableKeyboardCoordinates,
} from "@dnd-kit/sortable"
```

**Props:**
- selectedPipelineId: string
- pipelines: { id: string; name: string }[]
- stages: Stage[] (with type: 'open' | 'won' | 'lost')
- dealsByStage: { [stageId: string]: Deal[] }
- organizations, people for dropdowns
- onPipelineChange: (pipelineId: string) => void

**State:**
- dealsByStage (local state for optimistic updates)
- activeDeal (for DragOverlay)
- dealDialogOpen, selectedDeal for edit

**Sensors:**
- PointerSensor with activationConstraint: { distance: 5 }
- KeyboardSensor with sortableKeyboardCoordinates

**Handlers:**
1. **handleDragStart:** Set activeDeal from event.active.id
2. **handleDragOver:** When dragging over different column, optimistically move deal in local state
3. **handleDragEnd:** 
   - If dropped on different stage, call updateDealStage action
   - Revert optimistic update on error
   - Clear activeDeal

**Layout:**
1. Pipeline selector dropdown at top
2. Flex container with horizontal scroll for columns
3. Open stages as regular columns (filter stages where type === 'open')
4. Won/Lost footer row (collapsed, not drag targets - just display counts)

**Column rendering:**
```tsx
<div className="flex gap-4 overflow-x-auto pb-4">
  {openStages.map((stage) => (
    <KanbanColumn key={stage.id} stage={stage} deals={dealsByStage[stage.id] || []}>
      <SortableContext items={dealsByStage[stage.id] || []} strategy={verticalListSortingStrategy}>
        {(dealsByStage[stage.id] || []).map((deal) => (
          <DealCard key={deal.id} deal={deal} onEdit={handleEditDeal} />
        ))}
      </SortableContext>
    </KanbanColumn>
  ))}
</div>
```

**Won/Lost footer:**
- Separate row below main kanban
- Show collapsed cards with counts and values
- emerald styling for Won, rose styling for Lost
- Do NOT make these drag targets

**DragOverlay:**
- Render DealCard with isOverlay prop when activeDeal exists

Use closestCorners (NOT closestCenter) for collision detection - important for stacked columns.
</action>
  <verify>
    TypeScript compiles, DndContext wraps columns correctly
  </verify>
  <done>
    KanbanBoard component with DndContext, closestCorners, drag handlers, and Won/Lost footer
  </done>
</task>

<task type="auto">
  <name>Task 3: Create kanban column component</name>
  <files>src/app/deals/kanban-column.tsx</files>
  <action>
Create column component with useDroppable for empty column support.

**Implementation following RESEARCH.md Pattern 2:**

```typescript
"use client"

import { useDroppable } from "@dnd-kit/core"
import { cn } from "@/lib/utils"
import { formatCurrency, sumDealValues } from "@/lib/currency"
import { STAGE_COLORS, type StageColor } from "@/lib/stage-colors"
```

**Props:**
- stage: { id, name, color, type }
- deals: Deal[]
- children: React.ReactNode (SortableContext from parent)

**useDroppable setup:**
```typescript
const { setNodeRef, isOver } = useDroppable({
  id: stage.id,
  data: { type: 'column', stage },
})
```

**Column styling:**
- Fixed width: w-[280px] min-w-[280px]
- Background: bg-muted/50
- Rounded corners
- isOver state: ring-2 ring-primary

**Header:**
- Stage name (bold)
- Color dot using STAGE_COLORS[stage.color]
- Deal count: {deals.length} deals
- Total value: formatCurrency(sumDealValues(deals))

**Content:**
- flex-1 with min-h-[200px] for empty columns
- Render children (SortableContext with DealCards)
- ref={setNodeRef} on the content container

**Empty state:**
- No special placeholder text, just empty space (cards can be dragged in)
</action>
  <verify>
    TypeScript compiles, useDroppable properly configured
  </verify>
  <done>
    KanbanColumn with useDroppable, stage header with counts/values, proper empty column support
  </done>
</task>

<task type="auto">
  <name>Task 4: Create deal card component</name>
  <files>src/app/deals/deal-card.tsx</files>
  <action>
Create card component with useSortable, inline expansion, and edit/delete actions.

**Implementation following RESEARCH.md Pattern 3:**

```typescript
"use client"

import { useState } from "react"
import { useSortable } from "@dnd-kit/sortable"
import { CSS } from "@dnd-kit/utilities"
import { cn } from "@/lib/utils"
import { formatCurrency } from "@/lib/currency"
import { Pencil, Trash2 } from "lucide-react"
import { Button } from "@/components/ui/button"
import { DealDialog } from "./deal-dialog"
// AlertDialog for delete
```

**Props:**
- deal: Deal (with organization and person relations)
- onEdit: (deal: Deal) => void (optional, for parent-level dialog control)
- isOverlay?: boolean (for DragOverlay rendering)

**useSortable setup:**
```typescript
const {
  attributes,
  listeners,
  setNodeRef,
  transform,
  transition,
  isDragging,
} = useSortable({ id: deal.id })

const style = {
  transform: CSS.Transform.toString(transform),
  transition,
}
```

**Card styling:**
- bg-card border rounded-lg p-3
- cursor-pointer for expansion click
- isDragging: opacity-50
- isExpanded: ring-2 ring-primary

**Collapsed card content:**
- Title (truncated if too long)
- Organization name OR person name (firstName lastName)
- Value (formatted currency) or "No Value"

**Inline expansion (isExpanded state):**
- Click anywhere on card to toggle
- Show expectedCloseDate if set
- Show notes (truncated to 2 lines with line-clamp-2) if set
- Edit button (opens DealDialog)
- Delete button (opens AlertDialog confirmation)

**Event handling:**
- Card click toggles expansion (stopPropagation not needed - no parent click handlers)
- Button clicks need stopPropagation to prevent card collapse
- Drag handle attributes/listeners go on the card wrapper, NOT on expansion area

**DragOverlay variant:**
- When isOverlay is true, render without useSortable (just presentational)
- Don't show expanded state in overlay

**Dialogs:**
- Import and render DealDialog for edit mode
- Import and render AlertDialog for delete confirmation
- Both controlled by local state (editDialogOpen, deleteDialogOpen)
</action>
  <verify>
    TypeScript compiles, useSortable properly configured, inline expansion works
  </verify>
  <done>
    DealCard with useSortable, inline expansion, edit via DealDialog, delete confirmation
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete deals & kanban system:
- Deals database schema with org/person/stage relations
- All CRUD server actions with gap-based positioning
- Currency formatting utility
- Deal create/edit dialog with validation
- Kanban board with drag-drop between stages
- Column headers with deal counts and values
- Inline card expansion with edit/delete
- Won/Lost footer row
- Pipeline selector dropdown
  </what-built>
  <how-to-verify>
1. Navigate to /deals - should show kanban board
2. Click "Add Deal" - dialog should open with all fields
3. Create a deal with title, value, org - should appear in first stage
4. Drag deal to another stage - should move and persist on refresh
5. Click deal card - should expand inline showing details
6. Click Edit in expanded card - dialog should open with pre-filled values
7. Update deal and save - changes should reflect
8. Click Delete in expanded card - confirmation dialog should appear
9. Confirm delete - deal should disappear
10. Check stage headers show correct counts and totals
11. Create deals in Won/Lost stages - should appear in footer row
12. Switch pipelines via dropdown - should show different stages/deals
  </how-to-verify>
  <resume-signal>Type "approved" if all verifications pass, or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- [ ] Page fetches all required data (pipelines, stages, deals, orgs, people)
- [ ] Kanban board uses DndContext with closestCorners
- [ ] Columns use useDroppable for empty column support
- [ ] Cards use useSortable for drag handling
- [ ] DragOverlay renders dragged card
- [ ] handleDragEnd calls updateDealStage action
- [ ] Stage headers show count and total value
- [ ] Won/Lost stages in footer row
- [ ] Cards expand inline on click
- [ ] Edit button opens DealDialog
- [ ] Delete button opens AlertDialog
- [ ] Pipeline selector changes displayed pipeline
- [ ] Human verification checkpoint passed
</verification>

<success_criteria>
- Kanban follows @dnd-kit patterns from RESEARCH.md
- Uses closestCorners (not closestCenter) for collision detection
- Empty columns accept drops via useDroppable
- Gap-based positioning for deal ordering
- Won/Lost in collapsed footer (not regular columns)
- All 6 phase success criteria met
</success_criteria>

<output>
After completion, create `.planning/phases/05-deals-kanban/05-03-SUMMARY.md`
</output>
