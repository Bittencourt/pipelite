---
phase: 05-deals-kanban
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/app/deals/deal-dialog.tsx
autonomous: true

must_haves:
  truths:
    - "User can open create dialog and fill deal details"
    - "User must select at least one of organization or person (client + server validation)"
    - "User can edit existing deal with pre-filled values"
    - "User can delete deal with AlertDialog confirmation"
    - "Value field shows currency formatting"
  artifacts:
    - path: "src/app/deals/deal-dialog.tsx"
      provides: "Create/edit deal dialog with form"
      exports: ["DealDialog"]
  key_links:
    - from: "DealDialog"
      to: "createDeal/updateDeal actions"
      via: "server action import"
      pattern: "createDeal|updateDeal"
    - from: "form validation"
      to: "org/person requirement"
      via: "Zod refine or manual check"
---

<objective>
Create deal create/edit dialog with form validation, org/person dropdowns, and delete confirmation. This enables users to manage deals before the kanban board is built.

Purpose: Provide the CRUD interface for deal management that will be triggered from kanban cards.
Output: Reusable DealDialog component with create/edit modes and delete confirmation.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deals-kanban/05-CONTEXT.md
@.planning/phases/05-deals-kanban/05-RESEARCH.md

# Prior work
@.planning/phases/05-deals-kanban/05-01-SUMMARY.md

# Existing patterns to follow
@src/app/admin/pipelines/[id]/stage-dialog.tsx
@src/app/admin/pipelines/[id]/delete-stage-dialog.tsx
@src/app/people/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deal dialog component</name>
  <files>src/app/deals/deal-dialog.tsx</files>
  <action>
Create a DealDialog component for creating and editing deals, following the StageDialog pattern from pipelines.

**Component structure (src/app/deals/deal-dialog.tsx):**

```typescript
"use client"

import { useState, useEffect } from "react"
import { useForm } from "react-hook-form"
import { zodResolver } from "@hookform/resolvers/zod"
import { Dialog, DialogContent, DialogHeader, DialogTitle } from "@/components/ui/dialog"
import { Button } from "@/components/ui/button"
import { Input } from "@/components/ui/input"
import { Textarea } from "@/components/ui/textarea"
import { Label } from "@/components/ui/label"
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from "@/components/ui/select"
import { AlertDialog, AlertDialogAction, AlertDialogCancel, AlertDialogContent, AlertDialogDescription, AlertDialogFooter, AlertDialogHeader, AlertDialogTitle } from "@/components/ui/alert-dialog"
import { createDeal, updateDeal, deleteDeal } from "./actions"
import { toast } from "sonner"
import { formatCurrency } from "@/lib/currency"
```

**Props interface:**
```typescript
interface DealDialogProps {
  mode: "create" | "edit"
  open: boolean
  onOpenChange: (open: boolean) => void
  // For create mode
  pipelines?: { id: string; name: string; stages: { id: string; name: string }[] }[]
  defaultStageId?: string
  // For edit mode
  deal?: {
    id: string
    title: string
    value: number | null
    expectedCloseDate: Date | null
    notes: string | null
    stageId: string
    organizationId: string | null
    personId: string | null
  }
  // Dropdown data
  organizations: { id: string; name: string }[]
  people: { id: string; firstName: string; lastName: string }[]
  stages: { id: string; name: string; pipelineId: string }[]
  onSuccess: () => void
}
```

**Form fields:**
1. Title (required, text input)
2. Value (optional, number input, shows formatted preview below)
3. Stage (required, select dropdown from stages)
4. Organization (optional, select dropdown from organizations)
5. Person (optional, select dropdown from people, shows "FirstName LastName")
6. Expected Close Date (optional, date input)
7. Notes (optional, textarea)

**Validation:**
- Client-side: Check at least one of org/person is selected before submit
- Show error toast if neither is selected
- Server will also validate (from 05-01)

**Value formatting:**
- Show live preview of formatted currency as user types (e.g., "Value: $1,234")
- Use formatCurrency from @/lib/currency

**Create mode:**
- Call createDeal action
- Show success toast
- Call onSuccess callback

**Edit mode:**
- Pre-fill all form values from deal prop
- Call updateDeal action with deal.id
- Show delete button that opens AlertDialog
- Delete button triggers deleteDeal action

**Delete confirmation:**
- Use AlertDialog (destructive pattern, same as delete-stage-dialog.tsx)
- Message: "Are you sure you want to delete this deal? This action cannot be undone."
- On confirm: call deleteDeal, close dialogs, show toast, call onSuccess

Do NOT use Controller for Select components - use watch/setValue pattern like in people dialogs (simpler with radix).
</action>
  <verify>
    TypeScript compiles without errors
  </verify>
  <done>
    DealDialog component exports with create/edit modes, org/person dropdowns, value formatting, and delete confirmation
  </done>
</task>

</tasks>

<verification>
- [ ] DealDialog component exists and exports
- [ ] Form has all 7 fields (title, value, stage, org, person, close date, notes)
- [ ] Stage dropdown populated from stages prop
- [ ] Organization dropdown populated from organizations prop
- [ ] Person dropdown shows "FirstName LastName" format
- [ ] Value shows live currency formatting preview
- [ ] Client-side validation for org/person requirement
- [ ] Edit mode pre-fills all values
- [ ] Delete button opens AlertDialog confirmation
- [ ] All actions call appropriate server actions
</verification>

<success_criteria>
- Dialog follows StageDialog patterns from pipelines
- Delete uses AlertDialog (destructive action pattern)
- Form validation matches server-side Zod schema from 05-01
- Value field integrates with formatCurrency utility
</success_criteria>

<output>
After completion, create `.planning/phases/05-deals-kanban/05-02-SUMMARY.md`
</output>
