---
phase: 05-deals-kanban
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/deals.ts
  - src/db/schema/_relations.ts
  - src/db/schema/index.ts
  - src/lib/currency.ts
  - src/app/deals/actions.ts
autonomous: true

must_haves:
  truths:
    - "Deal records can be stored with links to organization, person, stage, and owner"
    - "Deal values can be null (for 'No Value' deals)"
    - "At least one of org/person must be set (enforced in action validation)"
    - "Deals can be soft-deleted with deletedAt timestamp"
    - "Currency can be formatted consistently as $X,XXX"
  artifacts:
    - path: "src/db/schema/deals.ts"
      provides: "Deals table definition"
      contains: "export const deals = pgTable"
    - path: "src/db/schema/_relations.ts"
      provides: "Deals relations to stages, orgs, people, users"
      contains: "dealsRelations"
    - path: "src/lib/currency.ts"
      provides: "Currency formatting utility"
      exports: ["formatCurrency"]
    - path: "src/app/deals/actions.ts"
      provides: "Deal CRUD and positioning actions"
      exports: ["createDeal", "updateDeal", "deleteDeal", "updateDealStage", "reorderDeals"]
  key_links:
    - from: "src/app/deals/actions.ts"
      to: "src/db/schema/deals.ts"
      via: "import { deals } from schema"
      pattern: "from.*deals"
    - from: "actions"
      to: "database"
      via: "db.insert/update/delete"
      pattern: "db\\.(insert|update|delete)"
---

<objective>
Create the data layer for deals management: database schema with entity relationships, currency formatting utility, and all server actions for CRUD operations and drag-drop reordering.

Purpose: Establish the foundation for deal management that the kanban UI will consume.
Output: Deals table, relations, currency utility, and server actions.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-deals-kanban/05-CONTEXT.md
@.planning/phases/05-deals-kanban/05-RESEARCH.md

# Existing patterns to follow
@src/db/schema/people.ts
@src/db/schema/_relations.ts
@src/app/organizations/actions.ts
@src/db/schema/pipelines.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deals database schema and relations</name>
  <files>
    src/db/schema/deals.ts
    src/db/schema/_relations.ts
    src/db/schema/index.ts
  </files>
  <action>
Create the deals table following existing patterns from people.ts and organizations.ts.

**Schema (src/db/schema/deals.ts):**
```typescript
import { pgTable, text, timestamp, integer } from "drizzle-orm/pg-core"
import { users } from "./users"
import { organizations } from "./organizations"
import { people } from "./people"
import { stages } from "./pipelines"

export const deals = pgTable('deals', {
  id: text('id').primaryKey().$defaultFn(() => crypto.randomUUID()),
  title: text('title').notNull(),
  value: integer('value'), // nullable for "No Value"
  expectedCloseDate: timestamp('expected_close_date'),
  notes: text('notes'),
  stageId: text('stage_id').notNull().references(() => stages.id),
  organizationId: text('organization_id').references(() => organizations.id),
  personId: text('person_id').references(() => people.id),
  ownerId: text('owner_id').notNull().references(() => users.id),
  position: integer('position').notNull(),
  createdAt: timestamp('created_at').defaultNow().notNull(),
  updatedAt: timestamp('updated_at').defaultNow().notNull(),
  deletedAt: timestamp('deleted_at'),
})
```

**Relations (add to src/db/schema/_relations.ts):**
1. Import deals at the top
2. Add dealsRelations with one-to-one for stage, organization, person, owner
3. Update stagesRelations to add `deals: many(deals)`

**Index (add to src/db/schema/index.ts):**
Export deals before _relations import.

Run `npx drizzle-kit push` to apply schema changes.
</action>
  <verify>
    npx drizzle-kit push succeeds, TypeScript compiles without errors
  </verify>
  <done>
    Deals table exists in database with all FKs, relations are queryable via drizzle
  </done>
</task>

<task type="auto">
  <name>Task 2: Create currency formatting utility</name>
  <files>src/lib/currency.ts</files>
  <action>
Create a currency formatting utility using native Intl.NumberFormat.

**Implementation (src/lib/currency.ts):**
```typescript
export function formatCurrency(
  value: number | null | undefined,
  currency: string = 'USD'
): string {
  if (value === null || value === undefined) return 'No Value'
  
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency,
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(value)
}

// Helper for aggregating deal values
export function sumDealValues(deals: { value: number | null }[]): number {
  return deals.reduce((sum, deal) => sum + (deal.value ?? 0), 0)
}
```

Do NOT use external currency libraries - Intl.NumberFormat is native and sufficient.
</action>
  <verify>
    TypeScript compiles, formatCurrency(1234) returns "$1,234", formatCurrency(null) returns "No Value"
  </verify>
  <done>
    Currency formatting utility exports formatCurrency and sumDealValues functions
  </done>
</task>

<task type="auto">
  <name>Task 3: Create deals server actions</name>
  <files>src/app/deals/actions.ts</files>
  <action>
Create all server actions for deal management following the organizations/actions.ts pattern.

**Required actions:**

1. **createDeal** - Create new deal with validation
   - Zod schema: title (required, max 200), value (int, nullable), expectedCloseDate (date string, nullable), notes (max 2000, nullable), stageId (required), organizationId (nullable), personId (nullable)
   - MUST validate: at least one of organizationId or personId is set (use .refine)
   - Calculate position: max position in stage + 10 (gap-based ordering)
   - Convert empty strings to null for optional fields
   - Return { success: true, id } or { success: false, error }

2. **updateDeal** - Update existing deal
   - Same validation as create
   - Verify deal exists and user owns it
   - Return { success: true } or { success: false, error }

3. **deleteDeal** - Soft delete deal
   - Verify deal exists and user owns it
   - Set deletedAt timestamp
   - Return { success: true } or { success: false, error }

4. **updateDealStage** - Move deal to different stage (for drag-drop)
   - Parameters: dealId, { stageId, position? }
   - If position not provided, calculate as max + 10
   - Return { success: true } or { success: false, error }

5. **reorderDeals** - Reorder within stage (for drag reorder in same column)
   - Parameters: stageId, dealId, newIndex
   - Use gap-based positioning (same logic as reorderStages from pipelines)
   - Return { success: true } or { success: false, error }

All actions must:
- Use auth() to verify session
- Use isNull(deals.deletedAt) in where clauses
- Revalidate "/deals" path on success
- Use console.error for catch blocks

Do NOT add ownership check in updateDealStage - any authenticated user can move deals (ownership can be refined later).
</action>
  <verify>
    TypeScript compiles without errors, all 5 actions are exported
  </verify>
  <done>
    Five server actions exist with proper validation, auth guards, and revalidation
  </done>
</task>

</tasks>

<verification>
- [ ] Deals table exists with all columns and FKs
- [ ] Relations connect deals to stages, organizations, people, users
- [ ] Currency utility exports formatCurrency and sumDealValues
- [ ] All 5 server actions exist with proper types
- [ ] createDeal validates at least one of org/person
- [ ] All actions use soft delete pattern (deletedAt check)
</verification>

<success_criteria>
- Deals schema matches RESEARCH.md specification exactly
- Relations follow existing _relations.ts patterns
- Actions follow organizations/actions.ts patterns with { success, error/id } return types
- Gap-based positioning implemented in createDeal and reorderDeals
</success_criteria>

<output>
After completion, create `.planning/phases/05-deals-kanban/05-01-SUMMARY.md`
</output>
