---
phase: 04-pipelines-stages
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/db/schema/pipelines.ts
  - src/db/schema/_relations.ts
  - src/db/schema/index.ts
  - src/lib/stage-colors.ts
  - src/components/admin-sidebar.tsx
autonomous: true
must_haves:
  truths:
    - "Pipeline table exists with id, name, isDefault, ownerId, timestamps, soft delete"
    - "Stage table exists with id, pipelineId, name, description, color, type, position"
    - "Stage names are unique within a pipeline"
    - "Stage colors are predefined palette keys"
    - "Admin sidebar shows Pipelines navigation item"
  artifacts:
    - path: "src/db/schema/pipelines.ts"
      provides: "Pipeline, Stage, PipelineVisibility table definitions"
      min_lines: 50
    - path: "src/lib/stage-colors.ts"
      provides: "Color palette constants and utilities"
      exports: ["STAGE_COLORS", "StageColor", "getNextColor"]
    - path: "src/components/admin-sidebar.tsx"
      provides: "Updated navigation with Pipelines link"
  key_links:
    - from: "src/db/schema/_relations.ts"
      to: "src/db/schema/pipelines.ts"
      via: "import and relations()"
      pattern: "pipelinesRelations|stagesRelations"
---

<objective>
Create the database schema for pipelines, stages, and pipeline visibility, plus the color palette utility. This establishes the data foundation for the entire pipelines feature.

Purpose: Define the database structure that enables admins to configure sales pipelines with ordered, typed stages.
Output: Schema files, relations, color utility, and admin navigation update.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipelines-stages/04-RESEARCH.md
@.planning/phases/04-pipelines-stages/04-CONTEXT.md
@src/db/schema/organizations.ts
@src/db/schema/_relations.ts
@src/db/schema/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline and stage database schema</name>
  <files>src/db/schema/pipelines.ts</files>
  <action>
Create `src/db/schema/pipelines.ts` with the following tables:

1. **pipelines table:**
   - id: text primary key with crypto.randomUUID()
   - name: text not null
   - isDefault: integer default 0 (0=false, 1=true for simple toggle)
   - ownerId: text not null references users.id
   - createdAt: timestamp defaultNow()
   - updatedAt: timestamp defaultNow()
   - deletedAt: timestamp (nullable, for soft delete)

2. **stages table:**
   - id: text primary key with crypto.randomUUID()
   - pipelineId: text not null references pipelines.id
   - name: text not null
   - description: text (nullable)
   - color: text not null default 'blue' (predefined color key)
   - type: stageTypeEnum default 'open' not null
   - position: integer not null (gap-based: 10, 20, 30...)
   - createdAt: timestamp defaultNow()
   - updatedAt: timestamp defaultNow()
   - Unique constraint on (pipelineId, name)

3. **pipelineVisibility table:**
   - pipelineId: text not null references pipelines.id
   - userId: text not null references users.id
   - Composite primary key on (pipelineId, userId)

Create the stage type enum: `pgEnum('stage_type', ['open', 'won', 'lost'])`

Import users from "./users" for foreign key references.

Follow the exact patterns from organizations.ts - same import style, same timestamp handling.
  </action>
  <verify>File exists with pipelines, stages, pipelineVisibility exports and stageTypeEnum</verify>
  <done>Schema file created with all three tables and enum, matching established patterns</done>
</task>

<task type="auto">
  <name>Task 2: Add pipeline and stage relations</name>
  <files>src/db/schema/_relations.ts, src/db/schema/index.ts</files>
  <action>
Update `src/db/schema/_relations.ts`:

1. Import pipelines and stages from respective files
2. Add pipelinesRelations:
   - owner: one(users)
   - stages: many(stages)
3. Add stagesRelations:
   - pipeline: one(pipelines)
4. Add pipelineVisibilityRelations if needed (optional, junction tables often don't need explicit relations)

Update `src/db/schema/index.ts`:
- Add `export * from "./pipelines"` after people export

Follow the exact relation patterns from organizationsRelations and peopleRelations in the file.
  </action>
  <verify>
    - _relations.ts contains pipelinesRelations and stagesRelations
    - index.ts exports from "./pipelines"
  </verify>
  <done>Relations defined and schemas exported from index</done>
</task>

<task type="auto">
  <name>Task 3: Create stage colors utility</name>
  <files>src/lib/stage-colors.ts</files>
  <action>
Create `src/lib/stage-colors.ts` with:

1. **STAGE_COLORS constant** - Object mapping color keys to Tailwind classes:
   - Colors: slate, blue, emerald, amber, rose, violet, cyan, orange (8 colors)
   - Each color has: bg, text, border, light variants
   - Use Tailwind color classes: bg-{color}-500, text-{color}-500, border-{color}-500, bg-{color}-100

2. **StageColor type** - keyof typeof STAGE_COLORS

3. **getNextColor function** - Takes array of existing colors, returns the least-used color:
   - Count occurrences of each color
   - Return color with lowest count
   - Used for auto-assigning colors to new stages

Example structure:
```typescript
export const STAGE_COLORS = {
  slate: { bg: 'bg-slate-500', text: 'text-slate-500', border: 'border-slate-500', light: 'bg-slate-100' },
  blue: { bg: 'bg-blue-500', text: 'text-blue-500', border: 'border-blue-500', light: 'bg-blue-100' },
  // ... 6 more colors
} as const;

export type StageColor = keyof typeof STAGE_COLORS;

export function getNextColor(existingColors: StageColor[]): StageColor {
  // Implementation
}
```
  </action>
  <verify>
    - File exports STAGE_COLORS object with 8 colors
    - File exports StageColor type
    - File exports getNextColor function
  </verify>
  <done>Color palette utility ready for use in stage UI components</done>
</task>

<task type="auto">
  <name>Task 4: Update admin sidebar with Pipelines link</name>
  <files>src/components/admin-sidebar.tsx</files>
  <action>
Update the sidebarItems array in `src/components/admin-sidebar.tsx`:

1. Import `Layers` icon from lucide-react (represents pipelines/stages)
2. Add new item after "User Management":
   ```typescript
   {
     title: "Pipelines",
     href: "/admin/pipelines",
     icon: Layers,
   }
   ```

The existing pattern uses lucide-react icons and simple object structure. Follow it exactly.
  </action>
  <verify>Admin sidebar renders with Pipelines link, uses Layers icon</verify>
  <done>Admin navigation updated to include Pipelines section</done>
</task>

</tasks>

<verification>
1. Run `npx drizzle-kit push` to verify schema is valid (or just check TypeScript compiles)
2. Verify all exports are accessible: `import { pipelines, stages, pipelineVisibility } from "@/db/schema"`
3. Verify color utility: `import { STAGE_COLORS, getNextColor } from "@/lib/stage-colors"`
</verification>

<success_criteria>
- [ ] pipelines table exists with id, name, isDefault, ownerId, timestamps, deletedAt
- [ ] stages table exists with id, pipelineId, name, description, color, type, position
- [ ] stageTypeEnum created with 'open', 'won', 'lost' values
- [ ] pipelineVisibility junction table exists with composite PK
- [ ] Unique constraint on (pipelineId, name) for stages
- [ ] Relations defined in _relations.ts
- [ ] Schemas exported from index.ts
- [ ] STAGE_COLORS has 8 color options with bg/text/border/light variants
- [ ] getNextColor function returns least-used color
- [ ] Admin sidebar shows Pipelines link with Layers icon
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipelines-stages/04-01-SUMMARY.md`
</output>
