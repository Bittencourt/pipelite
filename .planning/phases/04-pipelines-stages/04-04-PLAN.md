---
phase: 04-pipelines-stages
plan: 04
type: execute
wave: 4
depends_on: [04-02]
files_modified:
  - src/app/admin/pipelines/[id]/page.tsx
  - src/app/admin/pipelines/[id]/stage-configurator.tsx
  - src/app/admin/pipelines/[id]/stage-dialog.tsx
  - src/app/admin/pipelines/[id]/delete-stage-dialog.tsx
  - package.json
autonomous: false
must_haves:
  truths:
    - "Admin sees all stages in a pipeline ordered by position"
    - "Admin can drag stages to reorder them"
    - "Admin can add new stages with name, color, type"
    - "Admin can edit stage name, description, color, type"
    - "Admin can delete stages (with deal check)"
    - "Stage colors display as colored chips/badges"
    - "Won/Lost stages are visually distinguished"
    - "Exactly one Won and one Lost stage allowed per pipeline"
  artifacts:
    - path: "src/app/admin/pipelines/[id]/page.tsx"
      provides: "Pipeline detail page with stage list"
    - path: "src/app/admin/pipelines/[id]/stage-configurator.tsx"
      provides: "Drag-and-drop stage reordering"
      imports: ["@dnd-kit/react"]
    - path: "src/app/admin/pipelines/[id]/stage-dialog.tsx"
      provides: "Create/edit stage dialog with color picker"
  key_links:
    - from: "stage-configurator.tsx"
      to: "reorderStages action"
      via: "onDragEnd callback"
    - from: "stage-dialog.tsx"
      to: "createStage/updateStage actions"
      via: "form submit"
---

<objective>
Create the pipeline detail page with a drag-and-drop stage configurator. Admins can view, create, edit, delete, and reorder stages within a pipeline.

Purpose: Provide the full stage management interface with visual drag-and-drop reordering.
Output: Pipeline detail page, stage configurator with dnd-kit, and stage CRUD dialogs.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipelines-stages/04-RESEARCH.md
@.planning/phases/04-pipelines-stages/04-CONTEXT.md
@.planning/phases/04-pipelines-stages/04-02-SUMMARY.md
@src/app/admin/pipelines/actions.ts
@src/db/schema/pipelines.ts
@src/lib/stage-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dnd-kit and create pipeline detail page</name>
  <files>package.json, src/app/admin/pipelines/[id]/page.tsx</files>
  <action>
**1. Install @dnd-kit packages:**
```bash
npm install @dnd-kit/react @dnd-kit/dom
```

**2. Create src/app/admin/pipelines/[id]/page.tsx:**

- Async server component with params: { id: string }
- Query pipeline by id (check not deleted)
- Query all stages for pipeline, ordered by position ASC
- If pipeline not found, show 404 message
- Page structure:
  - Breadcrumb: Admin / Pipelines / {pipeline name}
  - Header: Pipeline name, "Back to Pipelines" link
  - Subtitle: "Configure stages for this pipeline"
  - Stage Configurator component (client component)
  - "Add Stage" button

- Pass to StageConfigurator:
  - pipelineId
  - stages array with: id, name, description, color, type, position
  - Callbacks for CRUD operations (passed to client component via props or fetched there)

The page uses the admin layout (inherited from /admin layout).
  </action>
  <verify>
    - npm install succeeds
    - /admin/pipelines/[id] renders pipeline name and stages
    - Stages display in position order
  </verify>
  <done>Pipeline detail page shows pipeline info and stages list</done>
</task>

<task type="auto">
  <name>Task 2: Create drag-and-drop stage configurator</name>
  <files>src/app/admin/pipelines/[id]/stage-configurator.tsx</files>
  <action>
Create `src/app/admin/pipelines/[id]/stage-configurator.tsx`:

**Imports:**
```typescript
import { DragDropProvider } from '@dnd-kit/react';
import { useSortable } from '@dnd-kit/react/sortable';
```

**Props:**
- pipelineId: string
- initialStages: Stage[] (from server)

**Component structure:**

1. **SortableStage component:**
   - useSortable hook with id and index
   - Displays: drag handle (GripVertical icon), color dot, name, type badge (if won/lost), edit/delete buttons
   - Visual feedback: opacity when dragging, border highlight when drop target
   - Uses STAGE_COLORS[color] for color dot styling

2. **StageConfigurator component:**
   - Local state: stages array (from initialStages prop)
   - DragDropProvider wrapper with onDragEnd callback
   - Horizontal flex container for stages (kanban-style columns)
   - Map stages to SortableStage components
   - "Add Stage" button at end

**Drag-and-drop logic:**
```typescript
<DragDropProvider
  onDragEnd={(event) => {
    if (event.canceled) return;
    const { source } = event.operation;
    // Get old and new indices
    const oldIndex = source.initialIndex;
    const newIndex = source.index;
    if (oldIndex !== newIndex) {
      // Optimistic update: reorder local state
      // Call reorderStages action
      // On error: revert local state
    }
  }}
>
```

**Stage card styling:**
- Card-like appearance with border
- Width: ~180px, min-width for content
- Color dot: 12px circle using STAGE_COLORS[color].bg
- Type badge for won/lost: green "Won" / red "Lost" badge
- Hover state: slight elevation
- Dragging state: opacity-50, scale effect

Include description tooltip if stage has description.
  </action>
  <verify>
    - Stages render horizontally in order
    - Dragging a stage shows visual feedback
    - Drop triggers reorderStages action
    - Stage order updates after drag
  </verify>
  <done>Drag-and-drop stage reordering works with optimistic updates</done>
</task>

<task type="auto">
  <name>Task 3: Create stage CRUD dialogs</name>
  <files>src/app/admin/pipelines/[id]/stage-dialog.tsx, src/app/admin/pipelines/[id]/delete-stage-dialog.tsx</files>
  <action>
**1. Create src/app/admin/pipelines/[id]/stage-dialog.tsx:**

Props:
- mode: 'create' | 'edit'
- pipelineId: string
- stage?: { id, name, description, color, type } (for edit)
- existingTypes: { hasWon: boolean, hasLost: boolean } (to disable type selection)
- open: boolean
- onOpenChange: (open: boolean) => void
- onSuccess: () => void

Form fields:
- Name: text input (required, min 1, max 50)
- Description: textarea (optional, max 200)
- Color: ColorPicker component (8 color buttons using STAGE_COLORS)
- Type: Select dropdown with options: Open, Won, Lost
  - Disable Won if existingTypes.hasWon && mode === 'create'
  - Disable Lost if existingTypes.hasLost && mode === 'create'
  - Show helper text: "Only one Won/Lost stage allowed per pipeline"

ColorPicker component (inline):
```tsx
function ColorPicker({ value, onChange }: { value: StageColor, onChange: (c: StageColor) => void }) {
  return (
    <div className="flex gap-2">
      {(Object.keys(STAGE_COLORS) as StageColor[]).map((color) => (
        <button
          key={color}
          type="button"
          onClick={() => onChange(color)}
          className={cn(
            "w-8 h-8 rounded-full border-2 transition-all",
            STAGE_COLORS[color].bg,
            value === color ? "ring-2 ring-offset-2 ring-primary" : "border-transparent hover:scale-110"
          )}
        />
      ))}
    </div>
  );
}
```

**2. Create src/app/admin/pipelines/[id]/delete-stage-dialog.tsx:**

Props:
- stage: { id, name, type }
- open: boolean
- onOpenChange: (open: boolean) => void
- onSuccess: () => void

AlertDialog pattern:
- Title: "Delete Stage"
- Description: 
  - For won/lost: "This is a {type} stage. Deleting it may affect historical deal reporting. Are you sure you want to delete "{name}"?"
  - For open: "Are you sure you want to delete the stage "{name}"?"
- Note: Deal check happens server-side, error shown if deals exist
- Cancel and Delete buttons
- Call deleteStage action
- On success: close, revalidate, toast

**3. Wire dialogs into stage-configurator.tsx:**
- Add state for dialog open/close
- Add state for selected stage (for edit/delete)
- Add edit/delete buttons to each stage card
- "Add Stage" button opens create dialog
- Pass existingTypes prop (computed from current stages)
  </action>
  <verify>
    - Create dialog shows all form fields with color picker
    - Won/Lost options disabled if already exists
    - Edit dialog pre-fills all values
    - Delete dialog shows warning for won/lost stages
    - All actions update stage list
  </verify>
  <done>Stage create/edit/delete dialogs work with all validations</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete pipeline and stage management system:
- Pipeline list page at /admin/pipelines
- Pipeline CRUD (create, edit, delete, set default)
- Pipeline detail page showing stages
- Stage configurator with drag-and-drop reordering
- Stage CRUD dialogs with color picker and type selection
  </what-built>
  <how-to-verify>
1. Navigate to /admin/pipelines
2. Click "New Pipeline" - enter name, submit
3. Verify new pipeline appears with 6 default stages
4. Click pipeline name to open detail page
5. Drag a stage to reorder - verify order persists after refresh
6. Click "Add Stage" - create new stage with color/type
7. Edit a stage - change name, color, type
8. Try to create second "Won" stage - verify it's blocked
9. Delete a stage - verify confirmation and removal
10. Set pipeline as default - verify badge updates
11. Delete pipeline - verify it disappears from list
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
1. /admin/pipelines/[id] loads without errors
2. Stages display in horizontal layout with color dots
3. Drag and drop works and persists
4. Stage dialogs open and submit correctly
5. Won/Lost uniqueness enforced
6. All toast notifications appear
</verification>

<success_criteria>
- [ ] Pipeline detail page shows all stages in order
- [ ] Stages display with color dots and type badges
- [ ] Drag-and-drop reordering works with optimistic update
- [ ] Create stage dialog has name, description, color picker, type selector
- [ ] Color picker shows 8 predefined colors
- [ ] Won/Lost type options disabled if already exists
- [ ] Edit stage dialog pre-fills all values
- [ ] Delete stage dialog shows warning for won/lost stages
- [ ] Delete blocked if deals exist (server-side check)
- [ ] All mutations refresh the stage list
- [ ] Human verification checkpoint passed
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipelines-stages/04-04-SUMMARY.md`
</output>
