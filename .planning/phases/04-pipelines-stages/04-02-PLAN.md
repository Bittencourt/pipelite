---
phase: 04-pipelines-stages
plan: 02
type: execute
wave: 2
depends_on: [04-01]
files_modified:
  - src/app/admin/pipelines/actions.ts
autonomous: true
must_haves:
  truths:
    - "Admin can create a pipeline with default stages auto-created"
    - "Admin can update pipeline name and default status"
    - "Admin can soft-delete a pipeline"
    - "Admin can create stages with name, color, type, position"
    - "Admin can update stage properties"
    - "Admin can delete stages (blocked if deals exist)"
    - "Admin can reorder stages with gap-based positioning"
  artifacts:
    - path: "src/app/admin/pipelines/actions.ts"
      provides: "All server actions for pipelines and stages"
      exports: ["createPipeline", "updatePipeline", "deletePipeline", "createStage", "updateStage", "deleteStage", "reorderStages", "setDefaultPipeline"]
      min_lines: 200
  key_links:
    - from: "src/app/admin/pipelines/actions.ts"
      to: "src/db/schema/pipelines.ts"
      via: "import and db operations"
      pattern: "db\\.(insert|update|select).*pipelines|stages"
---

<objective>
Create all server actions for pipeline and stage CRUD operations, including drag-and-drop reordering with gap-based positioning.

Purpose: Provide the backend logic that enables admins to fully configure pipelines and stages.
Output: Complete server actions file with all CRUD and reordering operations.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipelines-stages/04-RESEARCH.md
@.planning/phases/04-pipelines-stages/04-CONTEXT.md
@.planning/phases/04-pipelines-stages/04-01-SUMMARY.md
@src/app/organizations/actions.ts
@src/db/schema/pipelines.ts
@src/lib/stage-colors.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline CRUD actions</name>
  <files>src/app/admin/pipelines/actions.ts</files>
  <action>
Create `src/app/admin/pipelines/actions.ts` with the following actions:

**1. createPipeline:**
- Validate user is authenticated AND is admin (check session.user.role === "admin")
- Validate name with Zod: min 1, max 100 characters
- Create pipeline in transaction:
  1. Insert pipeline with name, ownerId = session.user.id, isDefault = 0
  2. Insert default stages with positions 10, 20, 30, 40, 50, 60
- Default stages (from RESEARCH.md):
  ```typescript
  const DEFAULT_STAGES = [
    { name: 'Lead', color: 'slate', type: 'open' },
    { name: 'Qualified', color: 'blue', type: 'open' },
    { name: 'Proposal', color: 'amber', type: 'open' },
    { name: 'Negotiation', color: 'emerald', type: 'open' },
    { name: 'Won', color: 'emerald', type: 'won' },
    { name: 'Lost', color: 'rose', type: 'lost' },
  ];
  ```
- Revalidate /admin/pipelines
- Return { success: true, id: pipeline.id } or { success: false, error: string }

**2. updatePipeline:**
- Validate admin role
- Validate name (optional, min 1, max 100)
- Check pipeline exists and not soft-deleted
- Update name, updatedAt
- Revalidate /admin/pipelines and /admin/pipelines/[id]
- Return { success: true } or { success: false, error: string }

**3. deletePipeline (soft delete):**
- Validate admin role
- Check pipeline exists and not already deleted
- Set deletedAt = new Date(), updatedAt = new Date()
- Revalidate /admin/pipelines
- Return { success: true } or { success: false, error: string }

**4. setDefaultPipeline:**
- Validate admin role
- Set isDefault = 0 for ALL pipelines (unset previous default)
- Set isDefault = 1 for target pipeline
- Revalidate /admin/pipelines
- Return { success: true } or { success: false, error: string }

Follow the exact patterns from organizations/actions.ts:
- "use server" directive
- auth() for session
- Zod validation schemas
- Return object pattern: { success: true/false, error/id }
- Empty strings converted to null for optional fields
  </action>
  <verify>
    - File exports createPipeline, updatePipeline, deletePipeline, setDefaultPipeline
    - All actions check admin role
    - createPipeline creates default stages in transaction
  </verify>
  <done>Pipeline CRUD actions created with admin role checks and default stages</done>
</task>

<task type="auto">
  <name>Task 2: Create stage CRUD actions</name>
  <files>src/app/admin/pipelines/actions.ts</files>
  <action>
Add to `src/app/admin/pipelines/actions.ts`:

**1. createStage:**
- Validate admin role
- Validate: pipelineId (required), name (min 1, max 50), description (optional, max 200), color (from STAGE_COLORS keys), type ('open' | 'won' | 'lost')
- Check pipeline exists and not deleted
- Check stage name is unique within pipeline
- If type is 'won' or 'lost', check no other stage of same type exists in pipeline (exactly one allowed max)
- Calculate position: find max position in pipeline, add 10 (new stages go at end)
- Use getNextColor() to auto-assign color if not provided
- Insert stage
- Revalidate /admin/pipelines/[pipelineId]
- Return { success: true, id: stage.id } or { success: false, error: string }

**2. updateStage:**
- Validate admin role
- Validate: name (optional, min 1, max 50), description (optional, max 200), color (optional), type (optional)
- Check stage exists and pipeline not deleted
- If changing name, check uniqueness within pipeline
- If changing type to 'won' or 'lost', verify no other stage has that type (unless it's the same stage)
- Update fields, set updatedAt
- Revalidate /admin/pipelines/[pipelineId]
- Return { success: true } or { success: false, error: string }

**3. deleteStage:**
- Validate admin role
- Check stage exists
- **IMPORTANT:** Query deals table to check if any deals reference this stage
  - If deals exist, return { success: false, error: "Cannot delete stage with existing deals. Reassign deals first." }
- (Note: deals table doesn't exist yet in this phase, so just add a TODO comment for the check)
- Delete stage (hard delete, not soft)
- Revalidate /admin/pipelines/[pipelineId]
- Return { success: true } or { success: false, error: string }

Add Zod schemas at top of file for validation.
  </action>
  <verify>
    - File exports createStage, updateStage, deleteStage
    - createStage validates won/lost uniqueness
    - deleteStage has deal check placeholder (TODO for Phase 5)
  </verify>
  <done>Stage CRUD actions with type constraints and deletion protection</done>
</task>

<task type="auto">
  <name>Task 3: Create stage reordering action</name>
  <files>src/app/admin/pipelines/actions.ts</files>
  <action>
Add to `src/app/admin/pipelines/actions.ts`:

**reorderStages:**
- Validate admin role
- Parameters: pipelineId, stageId, newIndex (target position 0-indexed)
- Fetch all stages for pipeline, ordered by position ascending
- Find current index of the stage being moved
- If newIndex === currentIndex, return success (no change needed)
- Calculate new position using gap-based approach:
  - If newIndex === 0: new position = first stage position / 2
  - If newIndex >= stages.length - 1: new position = last stage position + 10
  - Otherwise: new position = (stages[newIndex-1].position + stages[newIndex].position) / 2
- Update stage with new position and updatedAt
- Revalidate /admin/pipelines/[pipelineId]
- Return { success: true } or { success: false, error: string }

Example logic:
```typescript
const stages = await db.query.stages.findMany({
  where: and(eq(stages.pipelineId, pipelineId)),
  orderBy: [asc(stages.position)],
});

const currentIndex = stages.findIndex(s => s.id === stageId);
if (currentIndex === -1) return { success: false, error: "Stage not found" };
if (currentIndex === newIndex) return { success: true };

let newPosition: number;
if (newIndex === 0) {
  newPosition = stages[0].position / 2;
} else if (newIndex >= stages.length - 1) {
  newPosition = stages[stages.length - 1].position + 10;
} else {
  const prevPos = stages[newIndex - 1].position;
  const nextPos = stages[newIndex].position;
  newPosition = (prevPos + nextPos) / 2;
}

await db.update(stages)
  .set({ position: newPosition, updatedAt: new Date() })
  .where(eq(stages.id, stageId));
```

This allows unlimited reorderings without full renumbering (gap-based approach from RESEARCH.md).
  </action>
  <verify>
    - reorderStages exported and works with gap-based positioning
    - Handles edge cases (first, last positions)
  </verify>
  <done>Stage reordering action with efficient gap-based positioning</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. All 8 actions exported: createPipeline, updatePipeline, deletePipeline, setDefaultPipeline, createStage, updateStage, deleteStage, reorderStages
3. Each action has admin role check
4. Zod schemas defined for validation
</verification>

<success_criteria>
- [ ] createPipeline creates pipeline with 6 default stages (Lead, Qualified, Proposal, Negotiation, Won, Lost)
- [ ] updatePipeline allows name changes
- [ ] deletePipeline performs soft delete (sets deletedAt)
- [ ] setDefaultPipeline ensures only one pipeline is default
- [ ] createStage validates won/lost uniqueness per pipeline
- [ ] createStage auto-assigns color using getNextColor
- [ ] updateStage validates name uniqueness within pipeline
- [ ] deleteStage has placeholder for deal existence check
- [ ] reorderStages uses gap-based positioning (averages neighbors)
- [ ] All actions check admin role
- [ ] All actions return { success: boolean, error/id? } pattern
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipelines-stages/04-02-SUMMARY.md`
</output>
