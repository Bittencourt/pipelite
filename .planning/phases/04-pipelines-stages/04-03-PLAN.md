---
phase: 04-pipelines-stages
plan: 03
type: execute
wave: 3
depends_on: [04-02]
files_modified:
  - src/app/admin/pipelines/page.tsx
  - src/app/admin/pipelines/columns.tsx
  - src/app/admin/pipelines/data-table.tsx
  - src/app/admin/pipelines/pipeline-dialog.tsx
  - src/app/admin/pipelines/delete-dialog.tsx
autonomous: true
must_haves:
  truths:
    - "Admin sees list of all pipelines with name and stage count"
    - "Admin can create new pipeline from list page"
    - "Admin can edit pipeline name from list page"
    - "Admin can delete pipeline with confirmation"
    - "Default pipeline is visually indicated"
    - "Deleted pipelines are hidden from list"
  artifacts:
    - path: "src/app/admin/pipelines/page.tsx"
      provides: "Pipeline list page"
      renders: ["DataTable with pipelines"]
    - path: "src/app/admin/pipelines/columns.tsx"
      provides: "Table column definitions"
      exports: ["columns"]
    - path: "src/app/admin/pipelines/pipeline-dialog.tsx"
      provides: "Create/edit pipeline dialog"
    - path: "src/app/admin/pipelines/delete-dialog.tsx"
      provides: "Delete confirmation dialog"
  key_links:
    - from: "src/app/admin/pipelines/page.tsx"
      to: "src/app/admin/pipelines/actions.ts"
      via: "Server actions import"
    - from: "src/app/admin/pipelines/columns.tsx"
      to: "pipeline-dialog.tsx and delete-dialog.tsx"
      via: "Dialog components in action cells"
---

<objective>
Create the pipeline list page with data table, create/edit dialog, and delete confirmation. Admins can view all pipelines and perform basic CRUD operations.

Purpose: Provide the main interface for admins to manage pipeline configurations.
Output: Complete pipeline list page with all CRUD UI components.
</objective>

<execution_context>
@~/.config/opencode/get-shit-done/workflows/execute-plan.md
@~/.config/opencode/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-pipelines-stages/04-RESEARCH.md
@.planning/phases/04-pipelines-stages/04-CONTEXT.md
@.planning/phases/04-pipelines-stages/04-02-SUMMARY.md
@src/app/organizations/page.tsx
@src/app/organizations/columns.tsx
@src/app/organizations/data-table.tsx
@src/app/organizations/organization-dialog.tsx
@src/app/organizations/delete-dialog.tsx
@src/app/admin/pipelines/actions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pipeline list page and data table</name>
  <files>src/app/admin/pipelines/page.tsx, src/app/admin/pipelines/columns.tsx, src/app/admin/pipelines/data-table.tsx</files>
  <action>
Create the pipeline list page following organizations page pattern:

**1. src/app/admin/pipelines/page.tsx:**
- Async server component
- Query pipelines with stages count (left join and count)
- Filter out soft-deleted pipelines (deletedAt is null)
- Order by isDefault DESC, then createdAt DESC
- Wrap in admin layout (already applies from /admin layout)
- Use Card component for container
- Include header with "Pipelines" title and "New Pipeline" button
- Pass data to DataTable

**2. src/app/admin/pipelines/columns.tsx:**
- Define Pipeline type with: id, name, isDefault, stageCount, createdAt
- Columns:
  - Name (sortable, links to /admin/pipelines/[id])
  - Stages (shows count as badge)
  - Default (shows "Default" badge if isDefault = 1)
  - Created (formatted date)
  - Actions (Edit button, Delete button, Set as Default button)
- Use table.meta pattern for passing callbacks (like organizations/columns.tsx)
- Import Layers icon from lucide-react for visual

**3. src/app/admin/pipelines/data-table.tsx:**
- Copy from organizations/data-table.tsx pattern
- Generic DataTable component accepting columns and data
- Include search/filter if needed (can be simple for now)
- Include "New Pipeline" button in toolbar

The page should render inside the existing admin layout (no separate layout needed).
  </action>
  <verify>
    - /admin/pipelines renders without errors
    - Table shows pipeline name, stage count, default indicator
    - Actions column has edit/delete buttons
  </verify>
  <done>Pipeline list page displays all non-deleted pipelines with actions</done>
</task>

<task type="auto">
  <name>Task 2: Create pipeline create/edit dialog</name>
  <files>src/app/admin/pipelines/pipeline-dialog.tsx</files>
  <action>
Create `src/app/admin/pipelines/pipeline-dialog.tsx`:

**Props:**
- mode: 'create' | 'edit'
- pipeline?: { id, name } (required for edit mode)
- onSuccess?: () => void

**Component structure:**
- Use Dialog, DialogContent, DialogHeader, DialogTitle, DialogDescription from shadcn
- Use Form with react-hook-form and zodResolver
- Single field: name (text input, required, min 1, max 100 chars)
- Submit button shows loading state during action
- Call createPipeline or updatePipeline based on mode
- On success: close dialog, call onSuccess, toast notification

**Form schema:**
```typescript
const pipelineSchema = z.object({
  name: z.string().min(1, "Name is required").max(100, "Name must be 100 characters or less"),
});
```

**State management:**
- open state controlled by parent (or use DialogTrigger)
- isSubmitting state for loading indicator
- Error state for displaying action errors

Follow the exact pattern from organizations/organization-dialog.tsx.
  </action>
  <verify>
    - Dialog opens for create mode
    - Dialog opens for edit mode with pre-filled name
    - Form validates name length
    - Submit calls correct action based on mode
  </verify>
  <done>Create/edit dialog works for both modes with validation</done>
</task>

<task type="auto">
  <name>Task 3: Create delete confirmation and set default</name>
  <files>src/app/admin/pipelines/delete-dialog.tsx, src/app/admin/pipelines/columns.tsx</files>
  <action>
**1. Create src/app/admin/pipelines/delete-dialog.tsx:**

Props:
- pipeline: { id, name }
- open: boolean
- onOpenChange: (open: boolean) => void
- onSuccess?: () => void

Component:
- AlertDialog pattern (like organizations/delete-dialog.tsx)
- Title: "Delete Pipeline"
- Description: "Are you sure you want to delete "{name}"? This will archive the pipeline. Deals will still be accessible."
- Cancel and Delete buttons
- Delete button shows loading state
- Call deletePipeline action
- On success: close dialog, revalidate, toast

**2. Update columns.tsx to wire dialogs:**
- Add callbacks for edit, delete, setDefault in table.meta
- Edit: Opens pipeline dialog in edit mode
- Delete: Opens delete confirmation
- Set Default: Calls setDefaultPipeline directly with optimistic update

**3. Update data-table.tsx:**
- Add PipelineDialog component (controlled open state)
- Add DeleteDialog component
- Wire up the callbacks from columns

The Set Default action should:
- Call setDefaultPipeline action
- Show loading state on the button
- Toast on success
- No confirmation needed (non-destructive)
  </action>
  <verify>
    - Delete dialog shows pipeline name in confirmation
    - Delete action soft-deletes pipeline
    - Set Default updates isDefault flag
    - All actions show toast notifications
  </verify>
  <done>Delete confirmation and set default functionality complete</done>
</task>

</tasks>

<verification>
1. Navigate to /admin/pipelines - page loads without errors
2. Click "New Pipeline" - dialog opens
3. Create pipeline - appears in list with 6 stages (checked in next phase)
4. Edit pipeline - name updates
5. Delete pipeline - confirmation shows, pipeline removed from list on confirm
6. Set as Default - default badge moves to selected pipeline
</verification>

<success_criteria>
- [ ] Pipeline list page shows all non-deleted pipelines
- [ ] Table displays name, stage count, default badge, created date
- [ ] Each row has Edit, Delete, Set as Default actions
- [ ] Create dialog validates name and creates pipeline
- [ ] Edit dialog pre-fills name and updates pipeline
- [ ] Delete dialog shows confirmation with pipeline name
- [ ] Set as Default updates the default indicator
- [ ] All mutations show toast notifications
- [ ] Page uses admin layout with sidebar navigation
</success_criteria>

<output>
After completion, create `.planning/phases/04-pipelines-stages/04-03-SUMMARY.md`
</output>
